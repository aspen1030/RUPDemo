<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Adler Dataset: Example of Workflow | RUPDemo Digitization Guide</title>
  <meta name="description" content="4 Adler Dataset: Example of Workflow | RUPDemo Digitization Guide" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Adler Dataset: Example of Workflow | RUPDemo Digitization Guide" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="docs" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Adler Dataset: Example of Workflow | RUPDemo Digitization Guide" />
  
  
  



<meta name="date" content="2024-09-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="genwf.html"/>
<link rel="next" href="adex.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I General Guidelines</b></span></li>
<li class="chapter" data-level="1" data-path="codestd.html"><a href="codestd.html"><i class="fa fa-check"></i><b>1</b> Coding Standards</a>
<ul>
<li class="chapter" data-level="1.1" data-path="codestd.html"><a href="codestd.html#starting-a-new-script"><i class="fa fa-check"></i><b>1.1</b> Starting a new script</a></li>
<li class="chapter" data-level="1.2" data-path="codestd.html"><a href="codestd.html#organizing-scripts"><i class="fa fa-check"></i><b>1.2</b> Organizing scripts</a></li>
<li class="chapter" data-level="1.3" data-path="codestd.html"><a href="codestd.html#formatting-sections-and-comments"><i class="fa fa-check"></i><b>1.3</b> Formatting sections and comments</a></li>
<li class="chapter" data-level="1.4" data-path="codestd.html"><a href="codestd.html#coding-style"><i class="fa fa-check"></i><b>1.4</b> Coding style</a></li>
<li class="chapter" data-level="1.5" data-path="codestd.html"><a href="codestd.html#writing-functions"><i class="fa fa-check"></i><b>1.5</b> Writing functions</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="projorg.html"><a href="projorg.html"><i class="fa fa-check"></i><b>2</b> Project Organization</a>
<ul>
<li class="chapter" data-level="2.1" data-path="projorg.html"><a href="projorg.html#folder-organization"><i class="fa fa-check"></i><b>2.1</b> Folder organization</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="projorg.html"><a href="projorg.html#r-folder"><i class="fa fa-check"></i><b>2.1.1</b> R folder</a></li>
<li class="chapter" data-level="2.1.2" data-path="projorg.html"><a href="projorg.html#data-folder"><i class="fa fa-check"></i><b>2.1.2</b> Data folder</a></li>
<li class="chapter" data-level="2.1.3" data-path="projorg.html"><a href="projorg.html#results-folder"><i class="fa fa-check"></i><b>2.1.3</b> Results folder</a></li>
<li class="chapter" data-level="2.1.4" data-path="projorg.html"><a href="projorg.html#example-of-folder-organization"><i class="fa fa-check"></i><b>2.1.4</b> Example of folder organization</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="projorg.html"><a href="projorg.html#more-complicated-datasets"><i class="fa fa-check"></i><b>2.2</b> More complicated datasets</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="genwf.html"><a href="genwf.html"><i class="fa fa-check"></i><b>3</b> General Workflow</a>
<ul>
<li class="chapter" data-level="3.1" data-path="genwf.html"><a href="genwf.html#incoming-candidates-for-digitization"><i class="fa fa-check"></i><b>3.1</b> Incoming candidates for digitization</a></li>
<li class="chapter" data-level="3.2" data-path="genwf.html"><a href="genwf.html#selecting-a-new-project"><i class="fa fa-check"></i><b>3.2</b> Selecting a new project</a></li>
<li class="chapter" data-level="3.3" data-path="genwf.html"><a href="genwf.html#supply-list"><i class="fa fa-check"></i><b>3.3</b> Supply list</a></li>
<li class="chapter" data-level="3.4" data-path="genwf.html"><a href="genwf.html#general-workflow-outline"><i class="fa fa-check"></i><b>3.4</b> General workflow outline</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="genwf.html"><a href="genwf.html#read-the-publication"><i class="fa fa-check"></i><b>3.4.1</b> 1. Read the publication</a></li>
<li class="chapter" data-level="3.4.2" data-path="genwf.html"><a href="genwf.html#sketch-an-outline-of-the-ipm"><i class="fa fa-check"></i><b>3.4.2</b> 2. Sketch an outline of the IPM</a></li>
<li class="chapter" data-level="3.4.3" data-path="genwf.html"><a href="genwf.html#list-the-equations-and-parameters-needed-to-recreate-the-ipm"><i class="fa fa-check"></i><b>3.4.3</b> 3. List the equations and parameters needed to recreate the IPM</a></li>
<li class="chapter" data-level="3.4.4" data-path="genwf.html"><a href="genwf.html#take-inventory"><i class="fa fa-check"></i><b>3.4.4</b> 4. Take inventory</a></li>
<li class="chapter" data-level="3.4.5" data-path="genwf.html"><a href="genwf.html#create-a-new-r-project"><i class="fa fa-check"></i><b>3.4.5</b> 5. Create a new R project</a></li>
<li class="chapter" data-level="3.4.6" data-path="genwf.html"><a href="genwf.html#script-01_dataformatting.r"><i class="fa fa-check"></i><b>3.4.6</b> 6. Script: 01_DataFormatting.R</a></li>
<li class="chapter" data-level="3.4.7" data-path="genwf.html"><a href="genwf.html#script-02_plotrawdata.r"><i class="fa fa-check"></i><b>3.4.7</b> 7. Script: 02_PlotRawData.R</a></li>
<li class="chapter" data-level="3.4.8" data-path="genwf.html"><a href="genwf.html#script-03_vitalratemodels.r"><i class="fa fa-check"></i><b>3.4.8</b> 8. Script: 03_VitalRateModels.R</a></li>
<li class="chapter" data-level="3.4.9" data-path="genwf.html"><a href="genwf.html#script-04_ipmscratch.r"><i class="fa fa-check"></i><b>3.4.9</b> 9. Script: 04_IPMScratch.R</a></li>
<li class="chapter" data-level="3.4.10" data-path="genwf.html"><a href="genwf.html#script-05_ipmr.r"><i class="fa fa-check"></i><b>3.4.10</b> 10. Script: 05_ipmr.R</a></li>
<li class="chapter" data-level="3.4.11" data-path="genwf.html"><a href="genwf.html#script-06_padrino.r"><i class="fa fa-check"></i><b>3.4.11</b> 11. Script: 06_PADRINO.R</a></li>
<li class="chapter" data-level="3.4.12" data-path="genwf.html"><a href="genwf.html#final-steps-of-digitization"><i class="fa fa-check"></i><b>3.4.12</b> 12. Final steps of digitization</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="genwf.html"><a href="genwf.html#why-do-we-construct-the-ipm-twice"><i class="fa fa-check"></i><b>3.5</b> Why do we construct the IPM twice?</a></li>
</ul></li>
<li class="part"><span><b>II Adler Dataset Example</b></span></li>
<li class="chapter" data-level="4" data-path="adwf.html"><a href="adwf.html"><i class="fa fa-check"></i><b>4</b> Adler Dataset: Example of Workflow</a>
<ul>
<li class="chapter" data-level="4.1" data-path="adwf.html"><a href="adwf.html#introduction-to-the-adler-dataset"><i class="fa fa-check"></i><b>4.1</b> Introduction to the Adler dataset</a></li>
<li class="chapter" data-level="4.2" data-path="adwf.html"><a href="adwf.html#publications-featuring-the-adler-dataset"><i class="fa fa-check"></i><b>4.2</b> Publications featuring the Adler dataset</a></li>
<li class="chapter" data-level="4.3" data-path="adwf.html"><a href="adwf.html#planttracker"><i class="fa fa-check"></i><b>4.3</b> plantTracker</a></li>
<li class="chapter" data-level="4.4" data-path="adwf.html"><a href="adwf.html#workflow-with-example-dataset"><i class="fa fa-check"></i><b>4.4</b> Workflow with example dataset</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="adwf.html"><a href="adwf.html#reading-the-publications"><i class="fa fa-check"></i><b>4.4.1</b> 1. Reading the publications</a></li>
<li class="chapter" data-level="4.4.2" data-path="adwf.html"><a href="adwf.html#sketching-an-outline-of-the-ipm"><i class="fa fa-check"></i><b>4.4.2</b> 2. Sketching an outline of the IPM</a></li>
<li class="chapter" data-level="4.4.3" data-path="adwf.html"><a href="adwf.html#making-the-parameter-shopping-list"><i class="fa fa-check"></i><b>4.4.3</b> 3. Making the parameter “shopping list”</a></li>
<li class="chapter" data-level="4.4.4" data-path="adwf.html"><a href="adwf.html#taking-inventory"><i class="fa fa-check"></i><b>4.4.4</b> 4. Taking inventory</a></li>
<li class="chapter" data-level="4.4.5" data-path="adwf.html"><a href="adwf.html#creating-a-new-r-project"><i class="fa fa-check"></i><b>4.4.5</b> 5. Creating a new R project</a></li>
<li class="chapter" data-level="4.4.6" data-path="adwf.html"><a href="adwf.html#data-formatting"><i class="fa fa-check"></i><b>4.4.6</b> 6. Data formatting</a></li>
<li class="chapter" data-level="4.4.7" data-path="adwf.html"><a href="adwf.html#plotting-the-raw-data"><i class="fa fa-check"></i><b>4.4.7</b> 7. Plotting the raw data</a></li>
<li class="chapter" data-level="4.4.8" data-path="adwf.html"><a href="adwf.html#fitting-vital-rate-models-for-the-mean-ipm"><i class="fa fa-check"></i><b>4.4.8</b> 8. Fitting vital rate models for the mean IPM</a></li>
<li class="chapter" data-level="4.4.9" data-path="adwf.html"><a href="adwf.html#buildipm4"><i class="fa fa-check"></i><b>4.4.9</b> 9. Building the IPM from scratch</a></li>
<li class="chapter" data-level="4.4.10" data-path="adwf.html"><a href="adwf.html#ipmr4"><i class="fa fa-check"></i><b>4.4.10</b> 10. Building the IPM with <code>ipmr</code></a></li>
<li class="chapter" data-level="4.4.11" data-path="adwf.html"><a href="adwf.html#populating-the-padrino-database-template"><i class="fa fa-check"></i><b>4.4.11</b> 11. Populating the PADRINO database template</a></li>
<li class="chapter" data-level="4.4.12" data-path="adwf.html"><a href="adwf.html#finishing-up-the-digitization-project"><i class="fa fa-check"></i><b>4.4.12</b> 12. Finishing up the digitization project</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="adex.html"><a href="adex.html"><i class="fa fa-check"></i><b>5</b> Adler Dataset: Extensions to the Mean IPM</a>
<ul>
<li class="chapter" data-level="5.1" data-path="adex.html"><a href="adex.html#exploring-our-options"><i class="fa fa-check"></i><b>5.1</b> Exploring our options</a></li>
<li class="chapter" data-level="5.2" data-path="adex.html"><a href="adex.html#plotting-by-year-x-treatment"><i class="fa fa-check"></i><b>5.2</b> Plotting by year x treatment</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="adyr.html"><a href="adyr.html"><i class="fa fa-check"></i><b>6</b> Adler Dataset: Extensions to the Mean IPM - Incorporating Year</a>
<ul>
<li class="chapter" data-level="6.0.1" data-path="adyr.html"><a href="adyr.html#making-the-parameter-shopping-list-1"><i class="fa fa-check"></i><b>6.0.1</b> 3. Making the parameter “shopping list”</a></li>
<li class="chapter" data-level="6.0.2" data-path="adyr.html"><a href="adyr.html#creating-new-folders-in-the-r-project"><i class="fa fa-check"></i><b>6.0.2</b> 5. Creating new folders in the R project</a></li>
<li class="chapter" data-level="6.0.3" data-path="adyr.html"><a href="adyr.html#data-formatting-1"><i class="fa fa-check"></i><b>6.0.3</b> 6. Data formatting</a></li>
<li class="chapter" data-level="6.0.4" data-path="adyr.html"><a href="adyr.html#plotting-the-raw-data-by-year"><i class="fa fa-check"></i><b>6.0.4</b> 7. Plotting the raw data by year</a></li>
<li class="chapter" data-level="6.0.5" data-path="adyr.html"><a href="adyr.html#fitting-vital-rate-models-with-the-random-effect-of-year"><i class="fa fa-check"></i><b>6.0.5</b> 8. Fitting vital rate models with the random effect of year</a></li>
<li class="chapter" data-level="6.0.6" data-path="adyr.html"><a href="adyr.html#building-the-year-specific-ipms-from-scratch"><i class="fa fa-check"></i><b>6.0.6</b> 9. Building the year-specific IPMs from scratch</a></li>
<li class="chapter" data-level="6.0.7" data-path="adyr.html"><a href="adyr.html#building-the-year-specific-ipms-with-ipmr"><i class="fa fa-check"></i><b>6.0.7</b> 10. Building the year-specific IPMs with <code>ipmr</code></a></li>
<li class="chapter" data-level="6.0.8" data-path="adyr.html"><a href="adyr.html#populating-the-padrino-database-template-1"><i class="fa fa-check"></i><b>6.0.8</b> 11. Populating the PADRINO database template</a></li>
<li class="chapter" data-level="6.0.9" data-path="adyr.html"><a href="adyr.html#finishing-up-the-digitization-project-1"><i class="fa fa-check"></i><b>6.0.9</b> 12. Finishing up the digitization project</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="useful-links.html"><a href="useful-links.html"><i class="fa fa-check"></i><b>A</b> Useful links</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">RUPDemo Digitization Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="adwf" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Adler Dataset: Example of Workflow<a href="adwf.html#adwf" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>At this point, we’ve planned out a roadmap for digitization in a general sense, but how do these steps actually happen in a real example? The following sections walk through the digitization of an IPM that Aldo and I worked on last year, using part of a dataset that you will soon become very familiar with! All of the code to reproduce the IPM is included, with extensive commentary to explain the different decisions we made along the way.</p>
<div id="introduction-to-the-adler-dataset" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Introduction to the Adler dataset<a href="adwf.html#introduction-to-the-adler-dataset" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The Adler dataset is composed of a collection of chart quadrat data that was collected across the western United States in the early to mid twentieth century. Chart quadrat data consists of paper maps that track each individual of each plant species in a 1 square meter plot from census to census (usually yearly but not always). Grasses are mapped as polygons and forbs are mapped as points. Because of these methods, IPMs can only be used to model the population dynamics of the grasses; forbs must be modeled using age-structured matrix models. Chart quadrats census the whole community, but here we will focus on the species with roughly 100 individuals per year.</p>
<p>Chart quadrat data are analyzed through the R package plantTracker to extract individual data on site, survival, and recruitment. We plan run plantTracker in advance, and to provide you with the data.</p>
<p>We will use the chart quadrat dataset collected from Colorado as our example to learn how to work with these data. There are six other sites that will then each be assigned to a digitizer (including one from Moore et al.); other datasets may follow later on. For now, we formatted data for a total of 15 IPMs, and at least 4 MPMs. If you end up needing to use plantTracker at any point to process a new incoming chart quadrat dataset, we have some example scripts you can use in addition to the resources provided with the plantTracker package documentation:</p>
<p><a href="https://doi.org/10.1111/2041-210X.13950" class="uri">https://doi.org/10.1111/2041-210X.13950</a><br />
<a href="https://github.com/aestears/plantTracker" class="uri">https://github.com/aestears/plantTracker</a></p>
<p>Digitizing models from the Adler dataset requires consulting with relevant publications which may have already parameterized models from these data, as well as modeling a bit at your own discretion with our guidance. The materials which follow should provide you with the tools to tackle the Adler dataset, but please don’t hesitate to ask for help!</p>
</div>
<div id="publications-featuring-the-adler-dataset" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Publications featuring the Adler dataset<a href="adwf.html#publications-featuring-the-adler-dataset" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Once you have been assigned to a site or subset of the Adler dataset, you should first read the publications which have already worked with the data. Note that the list below should not be considered exhaustive; you might find other papers which use these data and it is your job to make sure you read any that might be relevant. Additionally, not all of the papers below will be relevant to all of the species at your assigned site, and some of them may not be relevant at all to creating IPMs/MPMs. The list is just to provide you with some context about the dataset and give you a place to begin understanding how to model these data.</p>
<ul>
<li>All sites:
<ul>
<li>Chu et al., 2013, <em>Journal of Vegetation Science</em> <a href="https://doi.org/10.1111/jvs.12106" class="uri">https://doi.org/10.1111/jvs.12106</a></li>
<li>Stears et al., 2022, <em>Methods in Ecology and Evolution</em> <a href="https://doi.org/10.1111/2041-210X.13950" class="uri">https://doi.org/10.1111/2041-210X.13950</a></li>
<li>Chu &amp; Adler, 2015, <em>Ecological Monographs</em> <a href="https://doi.org/10.1890/14-1741.1" class="uri">https://doi.org/10.1890/14-1741.1</a> (except Colorado)</li>
<li>Chu et al., 2016, <em>Nature Communications</em> <a href="https://doi.org/10.1038/ncomms11766" class="uri">https://doi.org/10.1038/ncomms11766</a> (except Colorado)</li>
<li>Tredennick et al., 2018, <em>Ecology Letters</em> <a href="https://doi.org/10.1111/ele.13154" class="uri">https://doi.org/10.1111/ele.13154</a> (except Colorado)<br />
</li>
<li>Chu &amp; Adler, 2023, <em>Journal of Ecology</em> <a href="https://doi.org/10.1111/1365-2745.12212" class="uri">https://doi.org/10.1111/1365-2745.12212</a> (except Colorado)</li>
</ul></li>
<li>Colorado:
<ul>
<li>Chu et al., 2013, <em>Ecology</em> <a href="https://doi.org/10.1890/13-0121.1" class="uri">https://doi.org/10.1890/13-0121.1</a></li>
<li>Stears et al., 2022, <em>Ecology</em> <a href="https://doi.org/10.1002/ecy.3799" class="uri">https://doi.org/10.1002/ecy.3799</a></li>
</ul></li>
<li>Idaho:
<ul>
<li>Adler et al., 2010, <em>Ecology Letters</em> <a href="https://doi.org/10.1111/j.1461-0248.2010.01496.x" class="uri">https://doi.org/10.1111/j.1461-0248.2010.01496.x</a></li>
<li>Zachmann et al., 2010, <em>Ecology</em> <a href="https://doi.org/10.1890/10-0404.1" class="uri">https://doi.org/10.1890/10-0404.1</a></li>
<li>Dalgleish et al., 2011, <em>Ecology</em> <a href="https://doi.org/10.1890/10-0780.1" class="uri">https://doi.org/10.1890/10-0780.1</a></li>
</ul></li>
<li>Kansas:
<ul>
<li>Adler et al., 2007, <em>Ecology</em> <a href="https://doi.org/10.1890/0012-9658(2007)88%5B2673:LMQFKP%5D2.0.CO;2" class="uri">https://doi.org/10.1890/0012-9658(2007)88[2673:LMQFKP]2.0.CO;2</a></li>
<li>Lauenroth &amp; Adler, 2008, <em>Journal of Ecology</em> <a href="https://doi.org/10.1111/j.1365-2745.2008.01415.x" class="uri">https://doi.org/10.1111/j.1365-2745.2008.01415.x</a></li>
</ul></li>
<li>Arizona:
<ul>
<li>Anderson et al., 2012, <em>Ecology</em> <a href="https://doi.org/10.1890/11-2200.1" class="uri">https://doi.org/10.1890/11-2200.1</a></li>
</ul></li>
<li>Montana:
<ul>
<li>Anderson et al., 2011, <em>Ecology</em> <a href="https://doi.org/10.1890/11-0193.1" class="uri">https://doi.org/10.1890/11-0193.1</a></li>
<li>Tredennick et al., 2016, <em>Methods in Ecology and Evolution</em> <a href="https://doi.org/10.1111/2041-210X.12686" class="uri">https://doi.org/10.1111/2041-210X.12686</a></li>
</ul></li>
<li>New Mexico:
<ul>
<li>Christensen et al., 2021, <em>Ecology</em> <a href="https://doi.org/10.1002/ecy.3530" class="uri">https://doi.org/10.1002/ecy.3530</a></li>
</ul></li>
</ul>
</div>
<div id="planttracker" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> plantTracker<a href="adwf.html#planttracker" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The majority of the Adler dataset is available in its most raw form: digitized shapefiles of the original maps, and tabular data describing the shapefiles (as well as other information about the sites). The data must be transformed into a format that can be used to parameterize the vital rate models which we can do with the package plantTracker, developed by the Adler lab. Essentially, plantTracker overlays maps of each plot from successive timesteps and assigns unique identifiers to each individual based on their locations in the plot in order to track each individual throughout the monitored period. We can define a number of parameters to tell plantTracker how precisely polygons and points from successive years must overlap in order to be considered the same individual. Stears et al. (2022, <em>Methods in Ecology &amp; Evolution</em>) provides an excellent description of these parameters and how plantTracker works, if you are interested in reading more about it. For most of the Adler dataset, we will use the parameters described in the relevant publications (which I believe are also the default values). For the example dataset we will work through here (Colorado, focusing on <em>Bouteloua gracilis</em>), the call to use plantTracker looked like this:</p>
<pre><code>datTrackSpp &lt;- trackSpp( CO_grasses_raw_df,
                         quad_inventory_list,
                         dorm = 1,
                         buff = 0.05,
                         clonal = TRUE,
                         buffGenet = 0.05,
                         aggByGenet = TRUE,
                         flagSuspects = TRUE )</code></pre>
<p>Here, <code>CO_grasses_raw_df</code> was the raw dataframe containing all spatial information for all maps, filtered specifically to only include the grasses which had a minimum cover of 100, and <code>quad_inventory_list</code> included the metadata about each mapped quadrat. For the rest of the arguments:<br />
- <code>dorm = 1</code>: individuals are permitted to go dormant for one year and reappear in the same spot in year t2 as they appeared in year t0<br />
- <code>buff = 0.05</code>: individuals are allowed to “move” no more than 5 cm between years, which accounts for minor errors in mapping and also true variation in where individuals are located from year to year<br />
- <code>clonal = TRUE</code>: single genetic individuals (genets) can be composed of multiple vegetative segments (ramets) distributed across multiple rows of the data<br />
- <code>buffGenet = 0.05</code>: polygons of the same species within 5 cm of each other can be considered part of the same genet<br />
- <code>aggByGenet = TRUE</code>: multiple rows referring to the same genet will be aggregated so that each genet is only described by a single row<br />
- <code>flagSuspects = TRUE</code>: suspect observations will be flagged; observations can be suspect if an individual shrinks more than 10%, or if an individual which went dormant in time t1 had an area of less than 0.05 in time t0</p>
<p>The output of plantTracker is a dataframe describing the survival (and size, for grasses) of each individual throughout its entire tracked period. We can also see in which year an individual was added to the population as a recruit and the age of the individuals in each year, except for the individuals which were present in the first year.</p>
<pre><code>##      Quad       trackID Year basalArea_genet recruit survives_tplus1 age size_tplus1 nearEdge Suspect Treatment Pasture
## 1 gzgz_11 BOUGRA_1997_1 1997       0.4126254      NA               1  NA   0.4117354     TRUE   FALSE      gzgz      11
## 2 gzgz_11 BOUGRA_1997_1 1998       0.4117354      NA               1  NA   0.3879517     TRUE   FALSE      gzgz      11
## 3 gzgz_11 BOUGRA_1997_1 1999       0.3879517      NA               1  NA   0.3754913     TRUE   FALSE      gzgz      11
## 4 gzgz_11 BOUGRA_1997_1 2000       0.3754913      NA               1  NA   0.4095949     TRUE   FALSE      gzgz      11
## 5 gzgz_11 BOUGRA_1997_1 2001       0.4095949      NA               1  NA   0.1874513     TRUE   FALSE      gzgz      11
## 6 gzgz_11 BOUGRA_1997_1 2002       0.1874513      NA               1  NA   0.3677826     TRUE   FALSE      gzgz      11</code></pre>
<p>We can then use these data to parameterize vital rate models and then MPMs/IPMs, following the general workflow described in Chapter <a href="genwf.html#genwf">3</a>. Below, I will walk us through this workflow for our example species from Colorado, <em>Bouteloua gracilis</em>.</p>
</div>
<div id="workflow-with-example-dataset" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> Workflow with example dataset<a href="adwf.html#workflow-with-example-dataset" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="reading-the-publications" class="section level3 hasAnchor" number="4.4.1">
<h3><span class="header-section-number">4.4.1</span> 1. Reading the publications<a href="adwf.html#reading-the-publications" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The Colorado dataset is featured in four of the publications linked above. In Stears et al. (2022, <em>Methods in Ecology &amp; Evolution</em>), the dataset is only mentioned as an example of the type of data which can be analyzed using plantTracker, so there is nothing new to extract from here. In the other three papers, Chu et al. (2013, <em>Ecology</em>), Chu et al. (2013, <em>Journal of Ecology</em>), and Stears et al. (2022, <em>Ecology</em>), details are given about how the data were collected, but there is little else to gain for our models. The one piece of information that might be useful is that the tracked plots are not all equal; there are two levels of a grazing experiment (historically grazed or ungrazed, and grazed or ungrazed during the sampling period, four total treatment combinations) which we should consider analyzing separately (see Chapter <a href="adex.html#adex">5</a> ).</p>
</div>
<div id="sketching-an-outline-of-the-ipm" class="section level3 hasAnchor" number="4.4.2">
<h3><span class="header-section-number">4.4.2</span> 2. Sketching an outline of the IPM<a href="adwf.html#sketching-an-outline-of-the-ipm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We are going to use this dataset to produce a single IPM based on all of the aggregated data for <em>Bouteloua gracilis</em>. In theory, however, this dataset could be exploited in a number of different ways. We have sufficient data to produce yearly models, and RUPDemo focuses on temporal replication (in order to focus on the effects of yearly climate). Additionally, each of the six tracked pastures has one plot of each treatment combination: grazed in the past + grazed now (gzgz), ungrazed in the past + grazed now (ungz), grazed in the past + ungrazed now (gzun), and ungrazed in the past + ungrazed now (unun). In theory, we could construct as many as 126 IPMs from these data:</p>
<ul>
<li>1 IPM per transition, all plots aggregated (13 IPMs)<br />
</li>
<li>1 IPM using mean parameter values across all transitions and all plots (1 IPM)<br />
</li>
<li>1 IPM per transition, per treatment combination (13 x 4 = 52 IPMs)<br />
</li>
<li>1 IPM per treatment combination, using mean parameter values across all transitions (4 IPMs)<br />
</li>
<li>1 IPM per transition, per historical treatment, ignoring the current treatment (13 x 2 = 26 IPMs)<br />
</li>
<li>1 IPM per historical treatment, using mean parameter values across all transitions and ignoring the current treatment (2 IPMs)<br />
</li>
<li>1 IPM per transition, per current treatment, ignoring the historical treatment (13 x 2 = 26 IPMs)<br />
</li>
<li>1 IPM per current treatment, using mean parameter values across all transitions and ignoring the historical treatment (2 IPMs)</li>
</ul>
However, we don’t have enough data for this many IPMs. Remember, we want roughly 100 individuals per year, per treatment! This table describes the number of individuals from <em>Bouteloua gracilis</em> that are present in each year and treatment combination:
<center>
<table class="gmisc_table" style="border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;">
<thead>
<tr>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey;">
</th>
<th style="font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
gzgz
</th>
<th style="font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
gzun
</th>
<th style="font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
ungz
</th>
<th style="font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
unun
</th>
<th style="font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
Total
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
1997
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">10</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">6</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">14</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">12</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">42</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
1998
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">16</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">8</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">15</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">19</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">58</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
1999
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">43</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">29</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">33</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">54</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">159</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2000
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">43</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">5</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">20</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">16</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">84</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2001
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">54</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">23</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">45</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">52</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">174</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2002
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">123</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">22</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">65</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">724</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">934</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2003
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">99</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">12</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">38</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">137</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">286</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2004
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">118</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">18</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">53</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">94</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">283</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2005
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">78</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">14</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">46</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">35</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">173</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2006
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">67</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">10</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">104</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">52</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">233</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2007
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">143</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">39</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">46</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">86</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">314</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2008
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">134</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">50</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">64</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">94</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">342</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
2009
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">90</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">40</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">45</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:darkred;">70</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
<span style="color:forestgreen;">245</span>
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; border-bottom: 2px solid grey; text-align: left;">
2010
</td>
<td style="padding-left: 1em; padding-right: 1em; border-bottom: 2px solid grey; text-align: center;">
<span style="color:darkred;">71</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; border-bottom: 2px solid grey; text-align: center;">
<span style="color:darkred;">29</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; border-bottom: 2px solid grey; text-align: center;">
<span style="color:darkred;">53</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; border-bottom: 2px solid grey; text-align: center;">
<span style="color:darkred;">67</span>
</td>
<td style="padding-left: 1em; padding-right: 1em; border-bottom: 2px solid grey; text-align: center;">
<span style="color:forestgreen;">220</span>
</td>
</tr>
</tbody>
</table>
</center>
<p>Only a few treatment x year combinations have enough individuals for IPMs, and even if we aggregate all individuals across all treatments, three years have insufficient individuals! We could combine all yearly data, and produce four IPMs - one for each treatment. However, we will focus first on just constructing the mean IPM. In Chapters 5 through 7, we will explore some of these other options.</p>
<p>Let’s take a look at our data to see what kinds of information we have to work with:</p>
<pre><code>##      Quad       trackID Year basalArea_genet recruit survives_tplus1 age size_tplus1 nearEdge Suspect Treatment Pasture
## 1 gzgz_11 BOUGRA_1997_1 1997       0.4126254      NA               1  NA   0.4117354     TRUE   FALSE      gzgz      11
## 2 gzgz_11 BOUGRA_1997_1 1998       0.4117354      NA               1  NA   0.3879517     TRUE   FALSE      gzgz      11
## 3 gzgz_11 BOUGRA_1997_1 1999       0.3879517      NA               1  NA   0.3754913     TRUE   FALSE      gzgz      11
## 4 gzgz_11 BOUGRA_1997_1 2000       0.3754913      NA               1  NA   0.4095949     TRUE   FALSE      gzgz      11
## 5 gzgz_11 BOUGRA_1997_1 2001       0.4095949      NA               1  NA   0.1874513     TRUE   FALSE      gzgz      11
## 6 gzgz_11 BOUGRA_1997_1 2002       0.1874513      NA               1  NA   0.3677826     TRUE   FALSE      gzgz      11</code></pre>
<p>For each individual, we have information on the size at time t0 (basalareaGenet) and at time t1 (size_tplus1), whether the individual survives from t0 to t1 (survives_tplus1), and whether the individual is a recruit in a given year (NA meaning that the individual was present in the first year so we cannot know if it is a recruit or not, 0 meaning not a recruit, 1 meaning it is a recruit). From this information, we will be able to construct our three vital rate models.</p>
<p>Our recruitment data is available at the plot-level, but we do not have any information about how many recruits are produced by a given individual. Therefore, our recruitment model must be constructed as the number of recruits produced per non-recruit (henceforth, let’s call these “adults”) at time t0. This means that “recruits” are not a discrete stage but rather will be included as part of the continuous matrix describing size at t0 and size at t1, with the only thing differentiating recruits from adult plants is that in their first year (the year they are recruited into the population), the recruits can have an arbitrarily small size at t0 (when they were recorded as points rather than polygons on the map). Our IPM will therefore be the sum of the P kernel, <span class="math inline">\(P(z&#39;, z) = s(z) * G(z&#39;, z)\)</span>, and the F kernel, <span class="math inline">\(F(z&#39;) = f(z&#39;)\)</span>, where <span class="math inline">\(s(z)\)</span> represents the survival probability of an individual of size <span class="math inline">\(x\)</span> at time t0, <span class="math inline">\(G(z&#39;, z)\)</span> represents the transition from size <span class="math inline">\(z\)</span> at time t0 to size <span class="math inline">\(z&#39;\)</span> at time t1 (using a probability density distribution), and <span class="math inline">\(f(z&#39;)\)</span> represents the size <span class="math inline">\(z&#39;\)</span> of recruits at time t1 dependent on the number of non-recruits at time t0.</p>
</div>
<div id="making-the-parameter-shopping-list" class="section level3 hasAnchor" number="4.4.3">
<h3><span class="header-section-number">4.4.3</span> 3. Making the parameter “shopping list”<a href="adwf.html#making-the-parameter-shopping-list" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Given that we are building IPMs from data, we now need to estimate the parameters for the IPM submodels: the survival model <span class="math inline">\(s(z)\)</span>, the growth model, <span class="math inline">\(G(z&#39;,z)\)</span>, and the recruitment model, <span class="math inline">\(F(z&#39;)\)</span>.</p>
<div id="survival-model" class="section level4 hasAnchor" number="4.4.3.1">
<h4><span class="header-section-number">4.4.3.1</span> Survival model<a href="adwf.html#survival-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Survival is measured as binary data (0 = did not survive to time t1, 1 = survived to time t1) so it is modeled with a generalized linear model which uses a binomial distribution and a logit “link function”. In mathematical notation, we can describe the survival model as:</p>
<p><span class="math display">\[Logit(s(z)) = \beta_{s0} + \beta_{s1} * z\]</span></p>
<p>where <span class="math inline">\(z\)</span> is the size of an individual at time t0, <span class="math inline">\(\beta_{s0}\)</span> is the intercept and <span class="math inline">\(\beta_{s}\)</span> is the slope. To estimate <span class="math inline">\(\beta_{s0}\)</span> and <span class="math inline">\(\beta_{s1}\)</span> in R, we would model this as:</p>
<pre><code>glm( survives_t1 ~ size_t0, data = survival_df, family = binomial )</code></pre>
<p>In ipmr, due to a technical issue, the model is written using the inverse logit equation:</p>
<pre><code>s = 1 / ( 1 + exp( -( beta_s0 + beta_s1 * size_0 ) ) )</code></pre>
<p>The values for <code>beta_s0</code> and <code>beta_s1</code> will come from the model estimates from the R model, so these values will be added to our “shopping list.”</p>
</div>
<div id="growth-model" class="section level4 hasAnchor" number="4.4.3.2">
<h4><span class="header-section-number">4.4.3.2</span> Growth model<a href="adwf.html#growth-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The growth model, which describes the transition in size of an individual from time t0 to time t1, relies on a Gaussian probability density function to generate <span class="math inline">\(size_{t1}\)</span> (<span class="math inline">\(z&#39;\)</span> in the IPM model) given a certain <span class="math inline">\(size_{t0}\)</span> (<span class="math inline">\(z\)</span> in the IPM). We can write the growth model in a more conventional notation to better align with how we will need to write the model for PADRINO:</p>
<p><span class="math display">\[G(z&#39;, z) = f_{g}(z&#39;, \mu_{g}, \sigma_{g})\]</span>
<span class="math display">\[\mu_{g} = \beta_{g0} + \beta_{g1} * z\]</span>
<span class="math display">\[ \sigma_{g} = \sqrt{( a * e^{( b * z )} )}\]</span></p>
<p>where <span class="math inline">\(f_{g}\)</span> denotes the Gaussian probability density function which outputs the size of an individual at time t1 (<span class="math inline">\(z&#39;\)</span>) based on the size at time t0 (<span class="math inline">\(z\)</span>). In R, we will model <span class="math inline">\(\mu_{g}\)</span> to obtain the values <span class="math inline">\(\beta_{g0}\)</span> and <span class="math inline">\(\beta_{g1}\)</span>, and we will also model <span class="math inline">\(\sigma_{g}\)</span> using the nonlinear least-squares estimates to obtain the parameters which describe the variance of the growth model (where <code>a</code> is the intercept and <code>b</code> is the slope):</p>
<pre><code>lm( size_t1 ~ size_t0, data = growth_df )
nls( y ~ a * exp( b * x ), start = list( a = 1, b = 0 ) )</code></pre>
<p>Once we have all of the parameter values, we will need to write the growth model in three parts for PADRINO:</p>
<pre><code>g = Norm( mu_g, sigma_g )
mu_g = beta_g0 + beta_g1 * size_1
sigma_g = sqrt( a * exp( b * size_0 ) )</code></pre>
<p>In total, we are adding <code>beta_g0</code>, <code>beta_g1</code>, <code>a</code>, and <code>b</code> to our shopping list for the growth model.</p>
</div>
<div id="recruitment-model" class="section level4 hasAnchor" number="4.4.3.3">
<h4><span class="header-section-number">4.4.3.3</span> Recruitment model<a href="adwf.html#recruitment-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As previously discussed, the recruitment model will express a size-independent per-capita rate of recruitment. In mathematical notation:
<span class="math display">\[F(z&#39;) = \beta_{f} * r_{d}(z&#39;)\]</span>
<span class="math display">\[r_{d}(z&#39;) = f_{r_{d}}(z&#39;, \mu_{r_{d}}, \sigma_{r_{d}})\]</span></p>
<p>In R, we will write the model as:</p>
<pre><code>MASS::glm.nb( NRquad ~ 1, data = recr_df )</code></pre>
<p>This will give us our estimate for <span class="math inline">\(\beta_{f}\)</span>. The other estimates will come from the raw data. <span class="math inline">\(\beta_{f}\)</span> represents the mean per-capita recruitment rate, i.e. <code>N_recruit_t1 / N_adult_t0</code> for each plot x year; <span class="math inline">\(\mu_{r_{d}}\)</span> represents the mean size of recruits in year t0 when they were added to the population; and <span class="math inline">\(\sigma_{r_{d}}\)</span> represents the standard deviation of the recruit sizes in year t0. The recruitment model will be formatted for PADRINO as:</p>
<pre><code>fy = beta_f * r_d
r_d = Norm( recr_sz, recr_sd )</code></pre>
<p>Therefore, we will add <code>beta_f</code>, <code>recr_sz</code>, and <code>recr_sd</code> to the “shopping list” for the recruitment model.</p>
</div>
<div id="other-parameters" class="section level4 hasAnchor" number="4.4.3.4">
<h4><span class="header-section-number">4.4.3.4</span> Other parameters<a href="adwf.html#other-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In addition to the vital rate parameters, there are a few other parameters we will need to define in order to build our IPM in PADRINO. These include the minimum and maximum sizes over which we will integrate, as well as the number of bins that ipmr will use to solve the integral. We will calculate the minimum and maximum sizes from the raw data, and we will use 200 as the number of bins.</p>
</div>
</div>
<div id="taking-inventory" class="section level3 hasAnchor" number="4.4.4">
<h3><span class="header-section-number">4.4.4</span> 4. Taking inventory<a href="adwf.html#taking-inventory" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Based on our parameter shopping list we generated previously, we will need to calculate or generate estimates from linear models for all of our parameter values. If we were working with a published IPM, this is where we would consult the publication and supplemental materials to track down as many of these values as possible.</p>
</div>
<div id="creating-a-new-r-project" class="section level3 hasAnchor" number="4.4.5">
<h3><span class="header-section-number">4.4.5</span> 5. Creating a new R project<a href="adwf.html#creating-a-new-r-project" class="anchor-section" aria-label="Anchor link to header"></a></h3>
Here is an example of how we might organize this R project, assuming that we will write IPMs for other species from the Colorado site:
<center>
<table class="gmisc_table" style="border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;">
<tbody>
<tr style="border-top: 2px solid grey;">
<td style="border-top: 2px solid grey; text-align: left;">
📁 Adler_Colorado
</td>
<td style="border-top: 2px solid grey; text-align: left;">
</td>
<td style="border-top: 2px solid grey; text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
<span style="color:dodgerblue;">🅁</span> Adler_Colorado.Rproj
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
📁 data
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
📁 Bou_gra
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
📁 R
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
📁 Bou_gra
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
📁 results
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
📁 Bou_gra
</td>
</tr>
<tr>
<td style="border-bottom: 2px solid grey; text-align: left;">
</td>
<td style="border-bottom: 2px solid grey; text-align: left;">
📁 supplement
</td>
<td style="border-bottom: 2px solid grey; text-align: left;">
</td>
</tr>
</tbody>
</table>
</center>
</div>
<div id="data-formatting" class="section level3 hasAnchor" number="4.4.6">
<h3><span class="header-section-number">4.4.6</span> 6. Data formatting<a href="adwf.html#data-formatting" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To fit models from the raw data, we will produce separate data frames for the survival, growth, and recruitment models. The original files will be given to you as either .csv or .rds files, which contain the output from plantTracker. For now, we will assume that we’re working with the csv containing only the data for <em>Bouteloua gracilis</em>, which we abbreviate as “Bou_gra”.</p>
<pre><code>Bou_gra &lt;- read.csv( &quot;https://raw.githubusercontent.com/aspen1030/RUPDemo/main/Bou_gra.csv&quot; )</code></pre>
<p>We also want to take a moment to check the spatiotemporal replication of the entire dataset, to see if all plots were sampled in every year, or if any plots/years were skipped during data collection. Aldo and I will have already done this before sending you the data for your project and we will let you know if there are any inconsistencies to keep in mind, but let’s briefly walk through how we check for sampling completion. The easiest way is to just plot every year x quadrat combination in a grid and check for gaps:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="adwf.html#cb26-1" aria-hidden="true" tabindex="-1"></a>file_quads     <span class="ot">&lt;-</span> <span class="st">&#39;https://www.dropbox.com/scl/fi/vc5sg2fqj4kf5l9wbnjcj/quad_inventory.csv?rlkey=2arxy6cor1cwsbo4mul5z1dv1&amp;dl=1&#39;</span></span>
<span id="cb26-2"><a href="adwf.html#cb26-2" aria-hidden="true" tabindex="-1"></a>quad_inventory <span class="ot">&lt;-</span> <span class="fu">read.csv</span>( file_quads, <span class="at">sep =</span> <span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="adwf.html#cb26-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">pivot_longer</span>( gzgz_11<span class="sc">:</span>unun_7,</span>
<span id="cb26-4"><a href="adwf.html#cb26-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">names_to  =</span> <span class="st">&#39;Quad&#39;</span>,</span>
<span id="cb26-5"><a href="adwf.html#cb26-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">values_to =</span> <span class="st">&#39;Year&#39;</span> )</span>
<span id="cb26-6"><a href="adwf.html#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="adwf.html#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( quad_inventory, <span class="fu">aes</span>( <span class="at">x =</span> Year, <span class="at">y =</span> Quad ) ) <span class="sc">+</span> <span class="fu">geom_point</span>( )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>In this plot, a point indicates that a certain quadrat was surveyed in the year indicated on the x axis. Each quadrat is described by its treatment combination, followed by a number which refers to the pasture it is in. No data exist for a handful of quadrats in the year 2000, for any species. These discontinuities will not have substantial effects on vital rate estimation other than dramatically changing sample size in the 1999-2000 and 2000-2001 transitions. However, these discontinuities will require care when estimating population growth rates, which we will need to check our models. This is because, without care, we might get a crash in population growth in 1999-2000, and an explosion in 2000-2001.</p>
<p>Before we create our dataframes for each vital rate model, we need to update the 2009 survival data. Because we told plantTracker that plants can go dormant for 1 year, all individuals which were alive in 2009 but not recorded in 2010 (the final year of surveys) are given an “NA” value in the column describing survival to time t1. We’re going to go ahead and assume that these individuals all died, so those NA values need to be changed to zero.</p>
<pre><code>Bou_gra &lt;- Bou_gra %&gt;% 
  mutate( survives_tplus1 = replace( survives_tplus1,
                                     is.na( survives_tplus1 ) &amp; Year == 2009,
                                     0 ) )</code></pre>
<p>We can then test this:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="adwf.html#cb28-1" aria-hidden="true" tabindex="-1"></a>Bou_gra <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="adwf.html#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( Year ) <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="adwf.html#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( <span class="at">prop =</span> <span class="fu">sum</span>( survives_tplus1, <span class="at">na.rm =</span> T ) <span class="sc">/</span> <span class="fu">length</span>( survives_tplus1 ) )</span></code></pre></div>
<pre><code>## # A tibble: 14 × 2
##     Year  prop
##    &lt;int&gt; &lt;dbl&gt;
##  1  1997 0.857
##  2  1998 0.672
##  3  1999 0.415
##  4  2000 0.798
##  5  2001 0.753
##  6  2002 0.301
##  7  2003 0.493
##  8  2004 0.530
##  9  2005 0.676
## 10  2006 0.652
## 11  2007 0.739
## 12  2008 0.705
## 13  2009 0.686
## 14  2010 0</code></pre>
<p>Here we can see that the proportion of individuals which survive to time t1 in 2009 is not unrealistically higher than the other years, and since we remove the NAs in the calculation, the proportion of individuals in 2010 which survive to time t1 (2011) is zero, or otherwise completely unknown.</p>
<p>Now we can create a subsetted dataframe containing the information we need for our survival vital rate model:</p>
<pre><code>surv        &lt;- subset( Bou_gra, !is.na( survives_tplus1 ) ) %&gt;%
                      subset( basalArea_genet != 0 ) %&gt;%
                      select( Quad, Year, trackID, Treatment, Pasture,
                            basalArea_genet, logsize,
                            survives_tplus1, size_tplus1 )</code></pre>
<p>Here we are taking only individuals which we definitively know about their survival in year t1, which means we exclude the final year of sampling data since we do not know what happened in the following year. We also excluded individuals which have size_t0 (<code>basalArea_genet</code>) equal to zero since these individuals may have been tracked incorrectly. Lastly, we select the columns which might be relevant to our survival model, including information about the year, treatment, individual ID, size, and survival.</p>
<p>Next, we will create a subsetted dataframe containing the information we will need for our growth vital rate model:</p>
<pre><code>grow        &lt;- Bou_gra %&gt;% 
                      subset( basalArea_genet != 0) %&gt;%
                      subset( size_tplus1 != 0) %&gt;% 
                      select( Quad, Year, trackID, Treatment, Pasture,
                            basalArea_genet, logsize,
                            survives_tplus1, size_tplus1)</code></pre>
<p>Here we are excluding individuals which have size_t0 and size_t1 equal to zero (which died or recruited), and then selecting the same relevant columns.</p>
<p>Originally we thought that we should calculate the recruitment rate based on the mean area occupied by adults at time t0, which meant that we needed to calculate the total area occupied by adults for each plot x year:</p>
<pre><code>quad_df     &lt;- Bou_gra %&gt;%  
                  group_by( Species, Pasture, Quad, Year ) %&gt;% 
                  summarise( totParea = sum( basalArea_genet ) ) %&gt;% 
                  ungroup</code></pre>
<p>Then, we took the mean of these areas across each pasture x year:</p>
<pre><code>group_df    &lt;- quad_df %&gt;% 
                  group_by( Species, Pasture, Year ) %&gt;% 
                  summarise( Gcov = mean( totParea ) ) %&gt;% 
                  ungroup</code></pre>
<p>Next, we put the cover data together into one dataframe to link cover at time t0 to the number of recruits at time t1, dropping NAs just in case there were still any left at this point:</p>
<pre><code>cover_df     &lt;-  left_join( quad_df, group_df ) %&gt;% 
                  mutate( Year = Year + 1 ) %&gt;% 
                  mutate( Year = as.integer( Year ) ) %&gt;% 
                  drop_na()</code></pre>
<p>However, further exploration of the data resulted in this information being irrelevant to our model. In the model we will actually work with, we only need to calculate the number of recruits for each plot x year:</p>
<pre><code>recr_df     &lt;- Bou_gra %&gt;%  
                  group_by( Species, Pasture, Quad, Year ) %&gt;% 
                  summarise( NRquad   = sum( recruit, na.rm=T ) ) %&gt;% 
                  ungroup</code></pre>
<p>The merged dataframes (dropping NAs which inevitably show up in NRquad) is what you will find in the Github, but just know that we will only work with the number of recruits per quad, NRquad, in <code>recr</code>:</p>
<pre><code>recr        &lt;- left_join( cover_df, recr_df ) %&gt;% 
                  drop_na</code></pre>
<p>Lastly, we should write these three dataframes as csv files to be loaded into the subsequent scripts:</p>
<pre><code>write.csv( surv, &quot;data/Bou_gra/survival_df.csv&quot; )
write.csv( grow, &quot;data/Bou_gra/growth_df.csv&quot; )
write.csv( recr, &quot;data/Bou_gra/recruitment_df.csv&quot; )</code></pre>
</div>
<div id="plotting-the-raw-data" class="section level3 hasAnchor" number="4.4.7">
<h3><span class="header-section-number">4.4.7</span> 7. Plotting the raw data<a href="adwf.html#plotting-the-raw-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this step, we will explore the raw data and make some decisions about excluding certain data points before we fit our vital rate models. Note that most figures are preceded by script which saves the figure to the ‘results’ folder in the R project; I have commented out this command because there is no need to run it in the Markdown file, but it is included to give you examples of how these plots could be named and which plots should be exported.</p>
<p>Let’s first plot the raw data using histograms to examine the distributions of size at t0 and size at t1.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="adwf.html#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># png( &#39;results/Bou_gra/histograms.png&#39;, width = 8, height = 3, units = &quot;in&quot;, res = 150 )</span></span>
<span id="cb38-2"><a href="adwf.html#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="adwf.html#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>( <span class="at">mfrow =</span> <span class="fu">c</span>( <span class="dv">1</span>, <span class="dv">2</span> ), <span class="at">mar =</span> <span class="fu">c</span>( <span class="fl">3.5</span>, <span class="fl">3.5</span>, <span class="dv">1</span>, <span class="fl">0.2</span> ), <span class="at">mgp =</span> <span class="fu">c</span>( <span class="dv">2</span>, <span class="fl">0.7</span>, <span class="dv">0</span> ), <span class="at">cex =</span> <span class="fl">0.8</span> )</span>
<span id="cb38-4"><a href="adwf.html#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="adwf.html#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>( Bou_gra<span class="sc">$</span>basalArea_genet, <span class="at">main =</span> <span class="st">&quot;Histogram of size at time t0&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;Size at time t0&quot;</span> )</span>
<span id="cb38-6"><a href="adwf.html#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>( Bou_gra<span class="sc">$</span>size_tplus1, <span class="at">main =</span> <span class="st">&quot;Histogram of size at time t1&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;Size at time t1&quot;</span> )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-19-1.png" width="768" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="adwf.html#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off( )</span></span></code></pre></div>
<p>It is immediately apparent that the vast majority of individuals are very small, but that there are a few individuals which are much larger. The distribution for size at time t1 is nearly identical to that of size at time t0. These data are not normally distributed, which we can consider correcting for by log-transforming the sizes:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="adwf.html#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># png( &#39;results/Bou_gra/histograms_log.png&#39;, width = 8, height = 3, units = &quot;in&quot;, res = 150 )</span></span>
<span id="cb40-2"><a href="adwf.html#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="adwf.html#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>( <span class="at">mfrow =</span> <span class="fu">c</span>( <span class="dv">1</span>, <span class="dv">2</span> ), <span class="at">mar =</span> <span class="fu">c</span>( <span class="fl">3.5</span>, <span class="fl">3.5</span>, <span class="dv">1</span>, <span class="fl">0.2</span> ), <span class="at">mgp =</span> <span class="fu">c</span>( <span class="dv">2</span>, <span class="fl">0.7</span>, <span class="dv">0</span> ), <span class="at">cex =</span> <span class="fl">0.8</span> )</span>
<span id="cb40-4"><a href="adwf.html#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="adwf.html#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>( Bou_gra<span class="sc">$</span>logsize, <span class="at">main =</span> <span class="st">&quot;Histogram of log-transformed size at time t0&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;log( Size at time t0 )&quot;</span> )</span>
<span id="cb40-6"><a href="adwf.html#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>( <span class="fu">log</span>( Bou_gra<span class="sc">$</span>size_tplus1 ), <span class="at">main =</span> <span class="st">&quot;Histogram of log-transformed size at time t1&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;log( Size at time t1 )&quot;</span> )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-20-1.png" width="768" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="adwf.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off( )</span></span></code></pre></div>
<p>Log transformation approaches a more normal distribution, especially in size at time t1, but the data are still not perfectly described by the normal distribution. For now, we will move on to plotting the vital rates and then revisit the distributions of the data once we filter out some datapoints.</p>
<p>Next, we want to plot all of the vital rates. In order to plot survival, we need to put the survival data into binned proportions. Since the survival data are binary, it is very hard to notice any patterns in the relationship between size_t0 and survival at t1 when the raw data are plotted, as the points just appear as solid lines at 0 and 1 on the y axis. But by binning the survival data into classes based on size_t0, we can examine the proportion of individuals in each size class which survive and therefore read the plot as “what is the relationship between size and probability of survival?”</p>
<p>Let’s first look at all of the survival data:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="adwf.html#cb42-1" aria-hidden="true" tabindex="-1"></a>h    <span class="ot">&lt;-</span> ( <span class="fu">max</span>( Bou_gra<span class="sc">$</span>logsize, <span class="at">na.rm =</span> T ) <span class="sc">-</span> <span class="fu">min</span>( Bou_gra<span class="sc">$</span>logsize, <span class="at">na.rm =</span> T ) ) <span class="sc">/</span> <span class="dv">20</span></span>
<span id="cb42-2"><a href="adwf.html#cb42-2" aria-hidden="true" tabindex="-1"></a>lwr  <span class="ot">&lt;-</span> <span class="fu">min</span>( Bou_gra<span class="sc">$</span>logsize, <span class="at">na.rm =</span> T ) <span class="sc">+</span> ( h <span class="sc">*</span> <span class="fu">c</span>( <span class="dv">0</span><span class="sc">:</span>( <span class="dv">20</span> <span class="sc">-</span> <span class="dv">1</span> ) ) )</span>
<span id="cb42-3"><a href="adwf.html#cb42-3" aria-hidden="true" tabindex="-1"></a>upr  <span class="ot">&lt;-</span> lwr <span class="sc">+</span> h</span>
<span id="cb42-4"><a href="adwf.html#cb42-4" aria-hidden="true" tabindex="-1"></a>mid  <span class="ot">&lt;-</span> lwr <span class="sc">+</span> ( <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> h )</span>
<span id="cb42-5"><a href="adwf.html#cb42-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-6"><a href="adwf.html#cb42-6" aria-hidden="true" tabindex="-1"></a>binned_prop <span class="ot">&lt;-</span> <span class="cf">function</span>( lwr_x, upr_x, response ){</span>
<span id="cb42-7"><a href="adwf.html#cb42-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-8"><a href="adwf.html#cb42-8" aria-hidden="true" tabindex="-1"></a>  id  <span class="ot">&lt;-</span> <span class="fu">which</span>( Bou_gra<span class="sc">$</span>logsize <span class="sc">&gt;</span> lwr_x <span class="sc">&amp;</span> Bou_gra<span class="sc">$</span>logsize <span class="sc">&lt;</span> upr_x ) </span>
<span id="cb42-9"><a href="adwf.html#cb42-9" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> Bou_gra[id,]</span>
<span id="cb42-10"><a href="adwf.html#cb42-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-11"><a href="adwf.html#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>( response <span class="sc">==</span> <span class="st">&#39;prob&#39;</span> ){   <span class="fu">return</span>( <span class="fu">sum</span>( tmp<span class="sc">$</span>survives_tplus1, <span class="at">na.rm =</span> T ) <span class="sc">/</span> <span class="fu">nrow</span>( tmp ) ) }</span>
<span id="cb42-12"><a href="adwf.html#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>( response <span class="sc">==</span> <span class="st">&#39;n_size&#39;</span> ){ <span class="fu">return</span>( <span class="fu">nrow</span>( tmp ) ) }</span>
<span id="cb42-13"><a href="adwf.html#cb42-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-14"><a href="adwf.html#cb42-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-15"><a href="adwf.html#cb42-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-16"><a href="adwf.html#cb42-16" aria-hidden="true" tabindex="-1"></a>y_binned <span class="ot">&lt;-</span> <span class="fu">Map</span>( binned_prop, lwr, upr, <span class="st">&#39;prob&#39;</span> ) <span class="sc">%&gt;%</span> unlist</span>
<span id="cb42-17"><a href="adwf.html#cb42-17" aria-hidden="true" tabindex="-1"></a>x_binned <span class="ot">&lt;-</span> mid</span>
<span id="cb42-18"><a href="adwf.html#cb42-18" aria-hidden="true" tabindex="-1"></a>y_n_size <span class="ot">&lt;-</span> <span class="fu">Map</span>( binned_prop, lwr, upr, <span class="st">&#39;n_size&#39;</span> ) <span class="sc">%&gt;%</span> unlist</span>
<span id="cb42-19"><a href="adwf.html#cb42-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-20"><a href="adwf.html#cb42-20" aria-hidden="true" tabindex="-1"></a>surv_binned <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">xx  =</span> x_binned, </span>
<span id="cb42-21"><a href="adwf.html#cb42-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">yy  =</span> y_binned,</span>
<span id="cb42-22"><a href="adwf.html#cb42-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">nn  =</span> y_n_size ) <span class="sc">%&gt;%</span> </span>
<span id="cb42-23"><a href="adwf.html#cb42-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>( <span class="fu">c</span>( <span class="st">&#39;logsize&#39;</span>, <span class="st">&#39;survives_tplus1&#39;</span>, <span class="st">&#39;n_size&#39;</span> ) )</span>
<span id="cb42-24"><a href="adwf.html#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="adwf.html#cb42-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-26"><a href="adwf.html#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="co"># png( &#39;results/Bou_gra/survival_binned.png&#39;, width = 6, height = 4, units = &quot;in&quot;, res = 150 )</span></span>
<span id="cb42-27"><a href="adwf.html#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="adwf.html#cb42-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( <span class="at">data  =</span> surv_binned, <span class="fu">aes</span>( <span class="at">x =</span> logsize, <span class="at">y =</span> survives_tplus1 ) ) <span class="sc">+</span></span>
<span id="cb42-29"><a href="adwf.html#cb42-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb42-30"><a href="adwf.html#cb42-30" aria-hidden="true" tabindex="-1"></a>              <span class="at">pch   =</span> <span class="dv">16</span>,</span>
<span id="cb42-31"><a href="adwf.html#cb42-31" aria-hidden="true" tabindex="-1"></a>              <span class="at">size  =</span> <span class="dv">1</span>,</span>
<span id="cb42-32"><a href="adwf.html#cb42-32" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">&#39;red&#39;</span> ) <span class="sc">+</span></span>
<span id="cb42-33"><a href="adwf.html#cb42-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>( <span class="at">breaks =</span> <span class="fu">c</span>( <span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span> ) ) <span class="sc">+</span></span>
<span id="cb42-34"><a href="adwf.html#cb42-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-35"><a href="adwf.html#cb42-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>( ) <span class="sc">+</span></span>
<span id="cb42-36"><a href="adwf.html#cb42-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>( <span class="at">axis.text =</span> <span class="fu">element_text</span>( <span class="at">size =</span> <span class="dv">8</span> ),</span>
<span id="cb42-37"><a href="adwf.html#cb42-37" aria-hidden="true" tabindex="-1"></a>         <span class="at">title     =</span> <span class="fu">element_text</span>( <span class="at">size =</span> <span class="dv">10</span> ) ) <span class="sc">+</span></span>
<span id="cb42-38"><a href="adwf.html#cb42-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">x =</span> <span class="fu">expression</span>( <span class="st">&#39;log(size)&#39;</span>[t0] ),</span>
<span id="cb42-39"><a href="adwf.html#cb42-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">expression</span>( <span class="st">&#39;Survival to time t1&#39;</span> ) )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-21-1.png" width="768" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="adwf.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off( )</span></span></code></pre></div>
<p>Together, the data show a general trend of increasing probability of survival as log( size_t0 ) increases, which we would expect.</p>
<p>Now we can take a look at the growth data:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="adwf.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># png( &#39;results/Bou_gra/growth.png&#39;, width = 6, height = 4, units = &quot;in&quot;, res = 150 )</span></span>
<span id="cb44-2"><a href="adwf.html#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="adwf.html#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data  =</span> grow, <span class="fu">aes</span>( <span class="at">x =</span> logsize, <span class="at">y =</span> <span class="fu">log</span>( size_tplus1 ) ) ) <span class="sc">+</span></span>
<span id="cb44-4"><a href="adwf.html#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb44-5"><a href="adwf.html#cb44-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">pch   =</span> <span class="dv">16</span>,</span>
<span id="cb44-6"><a href="adwf.html#cb44-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">size  =</span> <span class="fl">0.7</span>,</span>
<span id="cb44-7"><a href="adwf.html#cb44-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">&#39;red&#39;</span> ) <span class="sc">+</span></span>
<span id="cb44-8"><a href="adwf.html#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>( ) <span class="sc">+</span></span>
<span id="cb44-9"><a href="adwf.html#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>( <span class="at">axis.text     =</span> <span class="fu">element_text</span>( <span class="at">size   =</span> <span class="dv">8</span> ),</span>
<span id="cb44-10"><a href="adwf.html#cb44-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">title         =</span> <span class="fu">element_text</span>( <span class="at">size   =</span> <span class="dv">10</span> ) ) <span class="sc">+</span></span>
<span id="cb44-11"><a href="adwf.html#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">x =</span> <span class="fu">expression</span>( <span class="st">&#39;log( size )&#39;</span>[t0] ),</span>
<span id="cb44-12"><a href="adwf.html#cb44-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">expression</span>( <span class="st">&#39;log( size )&#39;</span>[t1] ) )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-22-1.png" width="768" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="adwf.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off( )</span></span></code></pre></div>
<p>The most obvious feature of this plot is the bold vertical line at the minimum of log( size_t0 ). These points represent individuals which were recruited into the population at time t0 (and were given an arbitrarily small area) and which grew to a larger size in time t1. More interesting are the points forming horizontal lines, which represent individuals which were of a decent size in time t0, but then regressed to the minimum size in year 1. It is possible that some of these individuals actually died after the census in t0 and a new seedling germinated in roughly the same place before the census in t1, but we really do not know for sure if this is the case for all of these individuals. Since it is possible that individuals regressed in size, we will keep these datapoints. Keep in mind the scale of the axes; since the sizes have been log-transformed, the largest size possible is 0, which corresponds to 1 m<span class="math inline">\(^2\)</span>. The rest of the plot appears more or less how we would expect: a positive relationship between size_t1 and size_t0, with some variation. Most individuals seem to fall between -9 (corresponding to 0.01 cm<span class="math inline">\(^2\)</span>) and -3 (corresponding to 4 cm<span class="math inline">\(^2\)</span>), which are all fairly small plants. It would not be unreasonable to assume that what appears from this plot as plants shrinking quite a lot from time t0 to time t1 are actually the result of measurement error. The only individuals we might consider filtering out are those with an “impossible” size, i.e. individuals whose size is smaller than the minimum size that we specified when assembling the plantTracker data.</p>
<p>Now that we have an idea of how the size and survival data look, let’s take a look at the per-capita recruitment:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="adwf.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># png( &#39;results/Bou_gra/recruit.png&#39;, width = 6, height = 4, units = &quot;in&quot;, res = 150 )</span></span>
<span id="cb46-2"><a href="adwf.html#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="adwf.html#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( recr, <span class="fu">aes</span>( <span class="at">x =</span> totParea, <span class="at">y =</span> NRquad ) ) <span class="sc">+</span> </span>
<span id="cb46-4"><a href="adwf.html#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb46-5"><a href="adwf.html#cb46-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">pch   =</span> <span class="dv">16</span>,</span>
<span id="cb46-6"><a href="adwf.html#cb46-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">size  =</span> <span class="dv">1</span>,</span>
<span id="cb46-7"><a href="adwf.html#cb46-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">&#39;red&#39;</span> ) <span class="sc">+</span></span>
<span id="cb46-8"><a href="adwf.html#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>( ) <span class="sc">+</span></span>
<span id="cb46-9"><a href="adwf.html#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">x =</span> <span class="fu">expression</span>( <span class="st">&#39;Total parent plant area&#39;</span>[t0] ),</span>
<span id="cb46-10"><a href="adwf.html#cb46-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">expression</span>( <span class="st">&#39;Number of recruits&#39;</span>[t1] ) )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-23-1.png" width="576" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="adwf.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off( )</span></span></code></pre></div>
<p>Immediately we notice an outlier which obscures our ability to examine the dataset as a whole. This is a single plot where 682 individuals were recruited into the plot in 2002. Let’s remove the outlier and take a look:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="adwf.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># png( &#39;results/Bou_gra/recruit_nomax.png&#39;, width = 6, height = 4, units = &quot;in&quot;, res = 150 )</span></span>
<span id="cb48-2"><a href="adwf.html#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="adwf.html#cb48-3" aria-hidden="true" tabindex="-1"></a>recr <span class="sc">%&gt;%</span> <span class="fu">filter</span>( NRquad <span class="sc">!=</span> <span class="fu">max</span>( recr<span class="sc">$</span>NRquad ) ) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>( <span class="fu">aes</span>( <span class="at">x =</span> totParea, <span class="at">y =</span> NRquad ) ) <span class="sc">+</span> </span>
<span id="cb48-4"><a href="adwf.html#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb48-5"><a href="adwf.html#cb48-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">pch   =</span> <span class="dv">16</span>,</span>
<span id="cb48-6"><a href="adwf.html#cb48-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">size  =</span> <span class="dv">1</span>,</span>
<span id="cb48-7"><a href="adwf.html#cb48-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">&#39;red&#39;</span> ) <span class="sc">+</span></span>
<span id="cb48-8"><a href="adwf.html#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>( ) <span class="sc">+</span></span>
<span id="cb48-9"><a href="adwf.html#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">x =</span> <span class="fu">expression</span>( <span class="st">&#39;Total parent plant area&#39;</span>[t0] ),</span>
<span id="cb48-10"><a href="adwf.html#cb48-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">expression</span>( <span class="st">&#39;Number of recruits&#39;</span>[t1] ) )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-24-1.png" width="576" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="adwf.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off( )</span></span></code></pre></div>
<p>Now we can see that most plots have very few or even no recruits, and that there appears to be a negative relationship between total parent plant area at time t0 and the number of recruits at time t1. Biologically, we might explain this as negative density dependence, where adult plants are suppressing recruitment into their direct vicinity to avoid competition with members of the same species, or it might simply be that the space is already occupied and there is nowhere for recruits to germinate. In plots with low parent plant area, there might be more open ground where germination can occur. We will not filter out any data from the recruitment dataframe.</p>
<p>We will, however, modify the handful of “impossibly small” individuals from the growth and survival data. These are individuals whose log( size ) at either t0 or t1 is less than the arbitrarily small size that was assigned to individuals that were recorded as points on the chart quadrat maps. For some reason, when these individuals were digitized, they were digitized as polygons that ended up with areas less than the arbitrarily small size (0.25 cm<span class="math inline">\(^2\)</span>, or -10.59663 on the log scale). There are three records with areas less than this size.</p>
<ul>
<li><p>Quad gzgz_24, BOUGRA_2003_53, 2003: This is a recruit in 2003 which dies before the census in 2004, so we will just change the size_t0:</p>
<pre><code>Bou_gra[which( Bou_gra$Quad    == &quot;gzgz_24&quot; &amp; 
               Bou_gra$trackID == &quot;BOUGRA_2003_53&quot; ),7]  &lt;- 0.000025
Bou_gra[which( Bou_gra$Quad    == &quot;gzgz_24&quot; &amp; 
               Bou_gra$trackID == &quot;BOUGRA_2003_53&quot; ),16] &lt;- log( 2.5e-05 )</code></pre></li>
<li><p>Quad gzgz_24, BOUGRA_2002_1, 2003: This plant recruited in 2002 but then shrank to below the minimum size in 2003, so we will need to change size_t0 in 2003 and size_t1 in 2002:</p>
<pre><code>Bou_gra[which( Bou_gra$Quad    == &quot;gzgz_24&quot; &amp; 
               Bou_gra$trackID == &quot;BOUGRA_2002_1&quot; &amp; 
               Bou_gra$Year    == &quot;2003&quot; ),7]            &lt;- 0.000025
Bou_gra[which( Bou_gra$Quad    == &quot;gzgz_24&quot; &amp; 
               Bou_gra$trackID == &quot;BOUGRA_2002_1&quot; &amp; 
               Bou_gra$Year    == &quot;2003&quot; ),16]           &lt;- log( 2.5e-05 )
Bou_gra[which( Bou_gra$Quad    == &quot;gzgz_24&quot; &amp; 
               Bou_gra$trackID == &quot;BOUGRA_2002_1&quot; &amp; 
               Bou_gra$Year    == &quot;2002&quot; ),11]           &lt;- 0.000025</code></pre></li>
<li><p>Quad ungz_24, BOUGRA_2006_7, 2006: This is a recruit in 2006 which entered the population with a size below the minimum size, so we will only need to change size_t0 in 2006:</p>
<pre><code>Bou_gra[which( Bou_gra$Quad    == &quot;ungz_24&quot; &amp; 
               Bou_gra$trackID == &quot;BOUGRA_2006_7&quot; &amp; 
               Bou_gra$Year    == &quot;2006&quot; ),7]            &lt;- 0.000025
Bou_gra[which( Bou_gra$Quad    == &quot;ungz_24&quot; &amp; 
               Bou_gra$trackID == &quot;BOUGRA_2006_7&quot; &amp; 
               Bou_gra$Year    == &quot;2006&quot; ),16]           &lt;- log( 2.5e-05 )</code></pre></li>
</ul>
<p>Once we perform these changes (which we should be recording in our notes file, by the way!), we should re-run the Data Formatting script on the modified <code>Bou_gra</code> dataframe and save new versions of the vital rate dataframes. Add a suffix to the file names like “_mod” or “_clean” when you write the new csvs to indicate that these files have the modified datapoints, and so you don’t write over the original versions in case you want to check something else out later!</p>
</div>
<div id="fitting-vital-rate-models-for-the-mean-ipm" class="section level3 hasAnchor" number="4.4.8">
<h3><span class="header-section-number">4.4.8</span> 8. Fitting vital rate models for the mean IPM<a href="adwf.html#fitting-vital-rate-models-for-the-mean-ipm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now that we have an idea of how our data are distributed and we have modified the occurrences that are not possible, we are ready to start fitting our vital rate models.</p>
<p>Let’s first do a bit more reformatting of the dataframes (after we’ve modified those individuals as mentioned in the previous step) to make our models more consistent:</p>
<pre><code>grow_df      &lt;- grow %&gt;% 
  mutate( logarea.t0 = log( basalArea_genet ),
          logarea.t1 = log( size_tplus1 ) )
          
surv_df      &lt;- surv %&gt;% 
  mutate( logarea = log( basalArea_genet ) )</code></pre>
<div id="growvr4" class="section level4 hasAnchor" number="4.4.8.1">
<h4><span class="header-section-number">4.4.8.1</span> Growth model<a href="adwf.html#growvr4" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now we can start by modelling growth, using the simplest model to describe the effect of size at time t0 on size at time t1.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="adwf.html#cb54-1" aria-hidden="true" tabindex="-1"></a>gr_mod_mean <span class="ot">&lt;-</span> <span class="fu">lm</span>( logarea.t1 <span class="sc">~</span> logarea.t0, <span class="at">data =</span> grow_df)</span></code></pre></div>
<p>Let’s check how well the mean model predicts the whole dataset.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="adwf.html#cb55-1" aria-hidden="true" tabindex="-1"></a>grow_df<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>( gr_mod_mean, <span class="at">type =</span> <span class="st">&quot;response&quot;</span> )</span>
<span id="cb55-2"><a href="adwf.html#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="adwf.html#cb55-3" aria-hidden="true" tabindex="-1"></a>grow_line <span class="ot">&lt;-</span> <span class="fu">ggplot</span>( grow_df, <span class="fu">aes</span>( <span class="at">x =</span> logarea.t0, <span class="at">y =</span> logarea.t1 ) ) <span class="sc">+</span></span>
<span id="cb55-4"><a href="adwf.html#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( ) <span class="sc">+</span></span>
<span id="cb55-5"><a href="adwf.html#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>( <span class="fu">aes</span>( <span class="at">intercept =</span> <span class="fu">coef</span>( gr_mod_mean )[<span class="dv">1</span>],</span>
<span id="cb55-6"><a href="adwf.html#cb55-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">slope     =</span> <span class="fu">coef</span>( gr_mod_mean )[<span class="dv">2</span>] ),</span>
<span id="cb55-7"><a href="adwf.html#cb55-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">color     =</span> <span class="st">&#39;red&#39;</span>,</span>
<span id="cb55-8"><a href="adwf.html#cb55-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lwd       =</span> <span class="dv">2</span> )</span>
<span id="cb55-9"><a href="adwf.html#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="adwf.html#cb55-10" aria-hidden="true" tabindex="-1"></a>grow_pred <span class="ot">&lt;-</span> <span class="fu">ggplot</span>( grow_df, <span class="fu">aes</span>( <span class="at">x =</span> logarea.t1, <span class="at">y =</span> pred ) ) <span class="sc">+</span></span>
<span id="cb55-11"><a href="adwf.html#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( ) <span class="sc">+</span></span>
<span id="cb55-12"><a href="adwf.html#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>( <span class="fu">aes</span>( <span class="at">intercept =</span> <span class="dv">0</span>,</span>
<span id="cb55-13"><a href="adwf.html#cb55-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">slope =</span> <span class="dv">1</span> ),</span>
<span id="cb55-14"><a href="adwf.html#cb55-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">&quot;red&quot;</span>,</span>
<span id="cb55-15"><a href="adwf.html#cb55-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">lwd =</span> <span class="dv">2</span> )</span>
<span id="cb55-16"><a href="adwf.html#cb55-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-17"><a href="adwf.html#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="co"># png( &#39;results/Bou_gra/grow_pred.png&#39;, width = 10, height = 8, units = &quot;in&quot;, res = 150 )</span></span>
<span id="cb55-18"><a href="adwf.html#cb55-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-19"><a href="adwf.html#cb55-19" aria-hidden="true" tabindex="-1"></a>grow_line <span class="sc">+</span> grow_pred <span class="sc">+</span> <span class="fu">plot_layout</span>( )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-27-1.png" width="960" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="adwf.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off( )</span></span></code></pre></div>
<p>The plot on the left shows the raw data with the model plotted over as a line, which seems to fit to the data more or less fine. The plot on the right shows the observed sizes at time t1 on the x axis and the sizes at time t1 predicted by the model on the y axis, with a 1:1 line plotted over the data. The model seems to slightly overestimate growth for smaller individuals, and slightly underestimate growth for the largest individuals.</p>
<p>Recall back to our “shopping list” that we constructed in step 3. Our growth model requires a slope and an intercept, which we can get from the output of the mean model, but also estimates of “a” and “b,” which will come from the variance model:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="adwf.html#cb57-1" aria-hidden="true" tabindex="-1"></a>x         <span class="ot">&lt;-</span> <span class="fu">fitted</span>( gr_mod_mean )</span>
<span id="cb57-2"><a href="adwf.html#cb57-2" aria-hidden="true" tabindex="-1"></a>y         <span class="ot">&lt;-</span> <span class="fu">resid</span>( gr_mod_mean )<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb57-3"><a href="adwf.html#cb57-3" aria-hidden="true" tabindex="-1"></a>gr_var_m  <span class="ot">&lt;-</span> <span class="fu">nls</span>( y <span class="sc">~</span> a <span class="sc">*</span> <span class="fu">exp</span>( b <span class="sc">*</span> x ), <span class="at">start =</span> <span class="fu">list</span>( <span class="at">a =</span> <span class="dv">1</span>, <span class="at">b =</span> <span class="dv">0</span> ) )</span></code></pre></div>
<p>We’ll get back to these later. For now, let’s move on to the survival model.</p>
</div>
<div id="survival-model-1" class="section level4 hasAnchor" number="4.4.8.2">
<h4><span class="header-section-number">4.4.8.2</span> Survival model<a href="adwf.html#survival-model-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This is the simplest model describing the effect of size at time t0 on survival to time t1:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="adwf.html#cb58-1" aria-hidden="true" tabindex="-1"></a>su_mod_mean <span class="ot">&lt;-</span> <span class="fu">glm</span>( survives_tplus1 <span class="sc">~</span> logarea, <span class="at">data =</span> surv_df, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span> )</span></code></pre></div>
<p>Let’s quickly plot the data and see how well the model fits:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="adwf.html#cb59-1" aria-hidden="true" tabindex="-1"></a>surv_x <span class="ot">&lt;-</span> <span class="fu">seq</span>( <span class="fu">min</span>( surv_df<span class="sc">$</span>logarea ), <span class="fu">max</span>( surv_df<span class="sc">$</span>logarea ), <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb59-2"><a href="adwf.html#cb59-2" aria-hidden="true" tabindex="-1"></a>surv_pred <span class="ot">&lt;-</span> boot<span class="sc">::</span><span class="fu">inv.logit</span>( <span class="fu">coef</span>( su_mod_mean )[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>( su_mod_mean )[<span class="dv">2</span>] <span class="sc">*</span> surv_x )</span>
<span id="cb59-3"><a href="adwf.html#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="adwf.html#cb59-4" aria-hidden="true" tabindex="-1"></a>surv_pred_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">logarea =</span> surv_x, <span class="at">survives_tplus1 =</span> surv_pred )</span>
<span id="cb59-5"><a href="adwf.html#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="adwf.html#cb59-6" aria-hidden="true" tabindex="-1"></a>surv_line <span class="ot">&lt;-</span> <span class="fu">ggplot</span>( ) <span class="sc">+</span></span>
<span id="cb59-7"><a href="adwf.html#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>( <span class="at">data =</span> surv_df, <span class="fu">aes</span>( <span class="at">x        =</span> logarea, </span>
<span id="cb59-8"><a href="adwf.html#cb59-8" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">y        =</span> survives_tplus1 ), </span>
<span id="cb59-9"><a href="adwf.html#cb59-9" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">alpha    =</span> <span class="fl">0.25</span>, </span>
<span id="cb59-10"><a href="adwf.html#cb59-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">width    =</span> <span class="dv">0</span>, </span>
<span id="cb59-11"><a href="adwf.html#cb59-11" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">height   =</span> <span class="fl">0.25</span> ) <span class="sc">+</span></span>
<span id="cb59-12"><a href="adwf.html#cb59-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>( <span class="at">data =</span> surv_pred_df, <span class="fu">aes</span>( <span class="at">x     =</span> logarea,</span>
<span id="cb59-13"><a href="adwf.html#cb59-13" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">y     =</span> survives_tplus1 ),</span>
<span id="cb59-14"><a href="adwf.html#cb59-14" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">color =</span> <span class="st">&#39;red&#39;</span>,</span>
<span id="cb59-15"><a href="adwf.html#cb59-15" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">lwd   =</span> <span class="dv">2</span> )</span>
<span id="cb59-16"><a href="adwf.html#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="adwf.html#cb59-17" aria-hidden="true" tabindex="-1"></a>surv_bin <span class="ot">&lt;-</span> <span class="fu">ggplot</span>( ) <span class="sc">+</span></span>
<span id="cb59-18"><a href="adwf.html#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="at">data =</span> surv_binned, <span class="fu">aes</span>( <span class="at">x     =</span> logsize, </span>
<span id="cb59-19"><a href="adwf.html#cb59-19" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">y     =</span> survives_tplus1 ) ) <span class="sc">+</span></span>
<span id="cb59-20"><a href="adwf.html#cb59-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>( <span class="at">data =</span> surv_pred_df, <span class="fu">aes</span>( <span class="at">x     =</span> logarea,</span>
<span id="cb59-21"><a href="adwf.html#cb59-21" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">y     =</span> survives_tplus1 ),</span>
<span id="cb59-22"><a href="adwf.html#cb59-22" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">color =</span> <span class="st">&#39;red&#39;</span>,</span>
<span id="cb59-23"><a href="adwf.html#cb59-23" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">lwd   =</span> <span class="dv">2</span> )</span>
<span id="cb59-24"><a href="adwf.html#cb59-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-25"><a href="adwf.html#cb59-25" aria-hidden="true" tabindex="-1"></a><span class="co"># png( &#39;results/Bou_gra/survival_pred.png&#39;, width = 10, height = 8, units = &quot;in&quot;, res = 150 )</span></span>
<span id="cb59-26"><a href="adwf.html#cb59-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-27"><a href="adwf.html#cb59-27" aria-hidden="true" tabindex="-1"></a>surv_line <span class="sc">+</span> surv_bin <span class="sc">+</span> <span class="fu">plot_layout</span>( )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-30-1.png" width="960" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="adwf.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off( )</span></span></code></pre></div>
<p>On the left, I’ve used <code>geom_jitter( )</code> and <code>alpha = 0.25</code> to help with the visualization of the raw data but it’s still hard to tell how well the mean model fits the data. On the right, I’ve plotted the binned data we looked at previously and now we can see that the mean model seems to fit pretty well.</p>
</div>
<div id="recruitment-model-1" class="section level4 hasAnchor" number="4.4.8.3">
<h4><span class="header-section-number">4.4.8.3</span> Recruitment model<a href="adwf.html#recruitment-model-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Moving on to the recruitment model, remember we are modeling a per-capita rate of recruitment based on the number of adults in time t0, and we currently have the number of recruits at time t1 and the area occupied by adults at time t0 for each plot. First, we model the number of recruits using the negative binomial distribution:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="adwf.html#cb61-1" aria-hidden="true" tabindex="-1"></a>rec_mod_mean <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">glm.nb</span>( NRquad <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> recr_df )</span></code></pre></div>
<p>Next, we use the <code>predict( )</code> function to predict the number of recruits per quad, and then we sum up the observed and predicted number of recruits across all quads:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="adwf.html#cb62-1" aria-hidden="true" tabindex="-1"></a>recr_df        <span class="ot">&lt;-</span> recr_df <span class="sc">%&gt;%</span> </span>
<span id="cb62-2"><a href="adwf.html#cb62-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>( <span class="at">pred_mod_mean =</span> <span class="fu">predict</span>( rec_mod_mean, <span class="at">type =</span> <span class="st">&quot;response&quot;</span> ) ) </span>
<span id="cb62-3"><a href="adwf.html#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="adwf.html#cb62-4" aria-hidden="true" tabindex="-1"></a>rec_sums_df_m <span class="ot">&lt;-</span> recr_df <span class="sc">%&gt;%</span></span>
<span id="cb62-5"><a href="adwf.html#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>( <span class="at">NRquad    =</span> <span class="fu">sum</span>( NRquad ),</span>
<span id="cb62-6"><a href="adwf.html#cb62-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">pred_mod_mean =</span> <span class="fu">sum</span>( pred_mod_mean ) )</span></code></pre></div>
<p>Then, we sum up the number of adults present across all time t0:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="adwf.html#cb63-1" aria-hidden="true" tabindex="-1"></a>indiv_m <span class="ot">&lt;-</span> surv_df <span class="sc">%&gt;%</span></span>
<span id="cb63-2"><a href="adwf.html#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>( <span class="at">n_adults =</span> <span class="fu">n</span>( ) )</span></code></pre></div>
<p>Finally, we join these two dataframes and calculate a per-capita recruitment rate based on our model and on the observed recruits:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="adwf.html#cb64-1" aria-hidden="true" tabindex="-1"></a>repr_pc_m <span class="ot">&lt;-</span> indiv_m <span class="sc">%&gt;%</span></span>
<span id="cb64-2"><a href="adwf.html#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>( rec_sums_df_m ) <span class="sc">%&gt;%</span></span>
<span id="cb64-3"><a href="adwf.html#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">repr_pc_mean   =</span> pred_mod_mean <span class="sc">/</span> n_adults ) <span class="sc">%&gt;%</span></span>
<span id="cb64-4"><a href="adwf.html#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">repr_pc_obs    =</span> NRquad <span class="sc">/</span> n_adults ) <span class="sc">%&gt;%</span></span>
<span id="cb64-5"><a href="adwf.html#cb64-5" aria-hidden="true" tabindex="-1"></a>  drop_na</span></code></pre></div>
<p>And now we can compare the observed per-capita recruitment rate to the modeled per-capita recruitment rate:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="adwf.html#cb65-1" aria-hidden="true" tabindex="-1"></a>repr_pc_m</span></code></pre></div>
<pre><code>##   n_adults NRquad pred_mod_mean repr_pc_mean repr_pc_obs
## 1     3327   1624          1624    0.4881274   0.4881274</code></pre>
<p>The values are exactly the same, as we would expect. We will calculate the mean and standard deviation of the recruit sizes in the next step.</p>
</div>
<div id="exporting-parameter-estimates" class="section level4 hasAnchor" number="4.4.8.4">
<h4><span class="header-section-number">4.4.8.4</span> Exporting parameter estimates<a href="adwf.html#exporting-parameter-estimates" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now that we have all of our vital rate models, we need to store the coefficients from these models into dataframes containing our parameter estimates for the IPM.</p>
<p>Starting with the growth model:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="adwf.html#cb67-1" aria-hidden="true" tabindex="-1"></a>grow_fe <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">coefficient =</span> <span class="fu">names</span>( <span class="fu">coef</span>( gr_mod_mean ) ),</span>
<span id="cb67-2"><a href="adwf.html#cb67-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">value       =</span> <span class="fu">coef</span>( gr_mod_mean ) )</span>
<span id="cb67-3"><a href="adwf.html#cb67-3" aria-hidden="true" tabindex="-1"></a>var_m   <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">coefficient =</span> <span class="fu">names</span>( <span class="fu">coef</span>( gr_var_m ) ),</span>
<span id="cb67-4"><a href="adwf.html#cb67-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">value       =</span> <span class="fu">coef</span>( gr_var_m ) )</span>
<span id="cb67-5"><a href="adwf.html#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="adwf.html#cb67-6" aria-hidden="true" tabindex="-1"></a>grow_out <span class="ot">&lt;-</span> <span class="fu">Reduce</span>( <span class="cf">function</span>(...) <span class="fu">rbind</span>(...), <span class="fu">list</span>( grow_fe, var_m ) ) <span class="sc">%&gt;%</span></span>
<span id="cb67-7"><a href="adwf.html#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">coefficient =</span> <span class="fu">as.character</span>( coefficient ) ) <span class="sc">%&gt;%</span></span>
<span id="cb67-8"><a href="adwf.html#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">coefficient =</span> <span class="fu">replace</span>( coefficient, </span>
<span id="cb67-9"><a href="adwf.html#cb67-9" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">grepl</span>( <span class="st">&quot;Intercept&quot;</span>, coefficient ),</span>
<span id="cb67-10"><a href="adwf.html#cb67-10" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;b0&quot;</span> ) )</span>
<span id="cb67-11"><a href="adwf.html#cb67-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-12"><a href="adwf.html#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv( grow_out, &quot;data/Bou_gra/grow_pars.csv&quot;, row.names = F )</span></span></code></pre></div>
<p>And then the survival model:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="adwf.html#cb68-1" aria-hidden="true" tabindex="-1"></a>surv_fe <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">coefficient =</span> <span class="fu">names</span>( <span class="fu">coef</span>( su_mod_mean ) ),</span>
<span id="cb68-2"><a href="adwf.html#cb68-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">value       =</span> <span class="fu">coef</span>( su_mod_mean ) )</span>
<span id="cb68-3"><a href="adwf.html#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="adwf.html#cb68-4" aria-hidden="true" tabindex="-1"></a>surv_out<span class="ot">&lt;-</span> <span class="fu">Reduce</span>( <span class="cf">function</span>(...) <span class="fu">rbind</span>(...), <span class="fu">list</span>( surv_fe ) ) <span class="sc">%&gt;%</span></span>
<span id="cb68-5"><a href="adwf.html#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">coefficient =</span> <span class="fu">as.character</span>( coefficient ) ) <span class="sc">%&gt;%</span></span>
<span id="cb68-6"><a href="adwf.html#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">coefficient =</span> <span class="fu">replace</span>( coefficient, </span>
<span id="cb68-7"><a href="adwf.html#cb68-7" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">grepl</span>( <span class="st">&quot;Intercept&quot;</span>, coefficient ),</span>
<span id="cb68-8"><a href="adwf.html#cb68-8" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;b0&quot;</span> ) )</span>
<span id="cb68-9"><a href="adwf.html#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="adwf.html#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv( surv_out, &quot;data/Bou_gra/surv_pars.csv&quot;, row.names = F )</span></span></code></pre></div>
<p>We also have some other parameters we need to gather, including the per-capita recruitment rate which we will store as <code>fecu_b0</code>:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="adwf.html#cb69-1" aria-hidden="true" tabindex="-1"></a>recSize <span class="ot">&lt;-</span> Bou_gra <span class="sc">%&gt;%</span> <span class="fu">subset</span>( recruit <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb69-2"><a href="adwf.html#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="adwf.html#cb69-3" aria-hidden="true" tabindex="-1"></a>others  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">coefficient =</span> <span class="fu">c</span>( <span class="st">&quot;rec_siz&quot;</span>, <span class="st">&quot;rec_sd&quot;</span>, </span>
<span id="cb69-4"><a href="adwf.html#cb69-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;max_siz&quot;</span>, <span class="st">&quot;min_siz&quot;</span>,</span>
<span id="cb69-5"><a href="adwf.html#cb69-5" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;fecu_b0&quot;</span> ),</span>
<span id="cb69-6"><a href="adwf.html#cb69-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">value       =</span> <span class="fu">c</span>( <span class="fu">mean</span>( <span class="fu">log</span>( recSize<span class="sc">$</span>basalArea_genet ) ), </span>
<span id="cb69-7"><a href="adwf.html#cb69-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">sd</span>( <span class="fu">log</span>( recSize<span class="sc">$</span>basalArea_genet ) ),</span>
<span id="cb69-8"><a href="adwf.html#cb69-8" aria-hidden="true" tabindex="-1"></a>                                        grow_df<span class="sc">$</span>logarea.t0 <span class="sc">%&gt;%</span> max, </span>
<span id="cb69-9"><a href="adwf.html#cb69-9" aria-hidden="true" tabindex="-1"></a>                                        grow_df<span class="sc">$</span>logarea.t0 <span class="sc">%&gt;%</span> min,</span>
<span id="cb69-10"><a href="adwf.html#cb69-10" aria-hidden="true" tabindex="-1"></a>                                        repr_pc_m<span class="sc">$</span>repr_pc_mean ) )</span>
<span id="cb69-11"><a href="adwf.html#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="adwf.html#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv( others, &quot;data/Bou_gra/other_pars.csv&quot;, row.names = F )</span></span></code></pre></div>
<p>Now, we are finally ready to start building the IPM!</p>
</div>
</div>
<div id="buildipm4" class="section level3 hasAnchor" number="4.4.9">
<h3><span class="header-section-number">4.4.9</span> 9. Building the IPM from scratch<a href="adwf.html#buildipm4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will first construct a dataframe containing all of our mean IPM parameters:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="adwf.html#cb70-1" aria-hidden="true" tabindex="-1"></a>extr_value <span class="ot">&lt;-</span> <span class="cf">function</span>(x, field){ <span class="fu">subset</span>( x, coefficient <span class="sc">==</span> field )<span class="sc">$</span>value }</span>
<span id="cb70-2"><a href="adwf.html#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="adwf.html#cb70-3" aria-hidden="true" tabindex="-1"></a>pars_mean  <span class="ot">&lt;-</span> <span class="fu">list</span>(  <span class="at">surv_b0 =</span> <span class="fu">extr_value</span>( surv_out, <span class="st">&quot;b0&quot;</span> ),</span>
<span id="cb70-4"><a href="adwf.html#cb70-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">surv_b1 =</span> <span class="fu">extr_value</span>( surv_out, <span class="st">&quot;logarea&quot;</span> ),</span>
<span id="cb70-5"><a href="adwf.html#cb70-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">grow_b0 =</span> <span class="fu">extr_value</span>( grow_out, <span class="st">&quot;b0&quot;</span> ),</span>
<span id="cb70-6"><a href="adwf.html#cb70-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">grow_b1 =</span> <span class="fu">extr_value</span>( grow_out, <span class="st">&quot;logarea.t0&quot;</span> ),</span>
<span id="cb70-7"><a href="adwf.html#cb70-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">a       =</span> <span class="fu">extr_value</span>( grow_out, <span class="st">&quot;a&quot;</span> ),</span>
<span id="cb70-8"><a href="adwf.html#cb70-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b       =</span> <span class="fu">extr_value</span>( grow_out, <span class="st">&quot;b&quot;</span> ),</span>
<span id="cb70-9"><a href="adwf.html#cb70-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fecu_b0 =</span> <span class="fu">extr_value</span>( others, <span class="st">&quot;fecu_b0&quot;</span> ),</span>
<span id="cb70-10"><a href="adwf.html#cb70-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">recr_sz =</span> <span class="fu">extr_value</span>( others, <span class="st">&quot;rec_siz&quot;</span> ),</span>
<span id="cb70-11"><a href="adwf.html#cb70-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">recr_sd =</span> <span class="fu">extr_value</span>( others, <span class="st">&quot;rec_sd&quot;</span> ),</span>
<span id="cb70-12"><a href="adwf.html#cb70-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">L       =</span> <span class="fu">extr_value</span>( others, <span class="st">&quot;min_siz&quot;</span> ),</span>
<span id="cb70-13"><a href="adwf.html#cb70-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">U       =</span> <span class="fu">extr_value</span>( others, <span class="st">&quot;max_siz&quot;</span> ),</span>
<span id="cb70-14"><a href="adwf.html#cb70-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mat_siz =</span> <span class="dv">200</span> )</span>
<span id="cb70-15"><a href="adwf.html#cb70-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-16"><a href="adwf.html#cb70-16" aria-hidden="true" tabindex="-1"></a>pars       <span class="ot">&lt;-</span> pars_mean</span>
<span id="cb70-17"><a href="adwf.html#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="adwf.html#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv( pars_mean, &quot;data/Bou_gra/pars_mean.csv&quot;, row.names = F )</span></span></code></pre></div>
<p>Next, we need to write functions to describe each vital rate. Let’s start with growth. Recall that our growth function was modeled as:</p>
<pre><code>lm( logarea.t1 ~ logarea.t0, data = grow_df )
nls( y ~ a * exp( b * x ), start = list( a = 1, b = 0 ) )</code></pre>
<p>And written in mathematical notation, as:
<span class="math display">\[G(z&#39;, z) = f_{g}(z&#39;, \mu_{g}, \sigma_{g})\]</span>
<span class="math display">\[\mu_{g} = \beta_{g0} + \beta_{g1} * z\]</span>
<span class="math display">\[ \sigma_{g} = \sqrt{( a * e^{( b * z )} )}\]</span></p>
<p>We need to write two functions: one which describes the standard deviation based on the input size at time t0, <span class="math inline">\(x\)</span>, and one which describes the transition from <span class="math inline">\(x\)</span> to the size at time t1, <span class="math inline">\(y\)</span>, using a probability density distribution where the mean is described by our growth model. We can do that as such:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="adwf.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function describing standard deviation of growth model</span></span>
<span id="cb72-2"><a href="adwf.html#cb72-2" aria-hidden="true" tabindex="-1"></a>grow_sd <span class="ot">&lt;-</span> <span class="cf">function</span>( x, pars ) {</span>
<span id="cb72-3"><a href="adwf.html#cb72-3" aria-hidden="true" tabindex="-1"></a>  pars<span class="sc">$</span>a <span class="sc">*</span> ( <span class="fu">exp</span>( pars<span class="sc">$</span>b <span class="sc">*</span> x ) ) <span class="sc">%&gt;%</span> sqrt </span>
<span id="cb72-4"><a href="adwf.html#cb72-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-5"><a href="adwf.html#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="adwf.html#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Function describing growth from size x to size y</span></span>
<span id="cb72-7"><a href="adwf.html#cb72-7" aria-hidden="true" tabindex="-1"></a>gxy <span class="ot">&lt;-</span> <span class="cf">function</span>( x, y, pars ) {</span>
<span id="cb72-8"><a href="adwf.html#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="fu">dnorm</span>( y,  <span class="at">mean =</span> pars<span class="sc">$</span>grow_b0 <span class="sc">+</span> pars<span class="sc">$</span>grow_b1<span class="sc">*</span>x,</span>
<span id="cb72-9"><a href="adwf.html#cb72-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">sd   =</span> <span class="fu">grow_sd</span>( x, pars ) ) )</span>
<span id="cb72-10"><a href="adwf.html#cb72-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, we need to write a function for survival. Recall the survival model:</p>
<pre><code>glm( survives_tplus1  ~ logarea, data = surv_df, family = &#39;binomial&#39; )</code></pre>
<p>And written in mathematical notation:
<span class="math display">\[Logit(s(z)) = \beta_{s0} + \beta_{s1} * z\]</span></p>
<p>For survival, we only need to write one function (relying on the inverse logit function). This function describes the survival probability of an individual given its size <span class="math inline">\(x\)</span>.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="adwf.html#cb74-1" aria-hidden="true" tabindex="-1"></a>inv_logit <span class="ot">&lt;-</span> <span class="cf">function</span>( x ) { <span class="fu">exp</span>( x ) <span class="sc">/</span> ( <span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>( x ) ) }</span>
<span id="cb74-2"><a href="adwf.html#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="adwf.html#cb74-3" aria-hidden="true" tabindex="-1"></a>sx <span class="ot">&lt;-</span> <span class="cf">function</span>( x, pars ) {</span>
<span id="cb74-4"><a href="adwf.html#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="fu">inv_logit</span>( pars<span class="sc">$</span>surv_b0 <span class="sc">+</span> pars<span class="sc">$</span>surv_b1 <span class="sc">*</span> x ) )</span>
<span id="cb74-5"><a href="adwf.html#cb74-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, we will link these functions together to describe the P kernel, <span class="math inline">\(P(z&#39;, z) = s(z) * G(z&#39;, z)\)</span>, describing the transition of an individual at time t0 to time t1 based on size at time t0, <span class="math inline">\(x\)</span>.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="adwf.html#cb75-1" aria-hidden="true" tabindex="-1"></a>pxy <span class="ot">&lt;-</span> <span class="cf">function</span>( x, y, pars ) {</span>
<span id="cb75-2"><a href="adwf.html#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="fu">sx</span>( x, pars ) <span class="sc">*</span> <span class="fu">gxy</span>( x, y, pars ) )</span>
<span id="cb75-3"><a href="adwf.html#cb75-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Lastly, we will build our recruitment function. Recall that our recruitment model is size-independent, so there is no <span class="math inline">\(z\)</span> input, but recruits have an associated size distribution, so the output of the function is expressed in terms of <span class="math inline">\(z&#39;\)</span>. This function is built after the mathematical notation:
<span class="math display">\[f(z&#39;) = \beta_{f} * r_{d}(z&#39;)\]</span>
<span class="math display">\[r_{d}(z&#39;) = f_{r_{d}}(z&#39;, \mu_{r_{d}}, \sigma_{r_{d}})\]</span>
However, both expressions will be accounted for in the same function:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="adwf.html#cb76-1" aria-hidden="true" tabindex="-1"></a>fy <span class="ot">&lt;-</span> <span class="cf">function</span>( y, pars, h ){</span>
<span id="cb76-2"><a href="adwf.html#cb76-2" aria-hidden="true" tabindex="-1"></a>  n_recr  <span class="ot">&lt;-</span> pars<span class="sc">$</span>fecu_b0</span>
<span id="cb76-3"><a href="adwf.html#cb76-3" aria-hidden="true" tabindex="-1"></a>  recr_y  <span class="ot">&lt;-</span> <span class="fu">dnorm</span>( y, pars<span class="sc">$</span>recr_sz, pars<span class="sc">$</span>recr_sd ) <span class="sc">*</span> h</span>
<span id="cb76-4"><a href="adwf.html#cb76-4" aria-hidden="true" tabindex="-1"></a>  recr_y  <span class="ot">&lt;-</span> recr_y <span class="sc">/</span> <span class="fu">sum</span>( recr_y )</span>
<span id="cb76-5"><a href="adwf.html#cb76-5" aria-hidden="true" tabindex="-1"></a>  f       <span class="ot">&lt;-</span> n_recr <span class="sc">*</span> recr_y</span>
<span id="cb76-6"><a href="adwf.html#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( f )</span>
<span id="cb76-7"><a href="adwf.html#cb76-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-8"><a href="adwf.html#cb76-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now that we have our vital rate functions, we are ready to assemble everything into the IPM kernel/matrix function:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="adwf.html#cb77-1" aria-hidden="true" tabindex="-1"></a>kernel <span class="ot">&lt;-</span> <span class="cf">function</span>( pars ) {</span>
<span id="cb77-2"><a href="adwf.html#cb77-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-3"><a href="adwf.html#cb77-3" aria-hidden="true" tabindex="-1"></a>  n   <span class="ot">&lt;-</span> pars<span class="sc">$</span>mat_siz                      <span class="co"># number of bins over which to integrate</span></span>
<span id="cb77-4"><a href="adwf.html#cb77-4" aria-hidden="true" tabindex="-1"></a>  L   <span class="ot">&lt;-</span> pars<span class="sc">$</span>L                            <span class="co"># lower limit of integration</span></span>
<span id="cb77-5"><a href="adwf.html#cb77-5" aria-hidden="true" tabindex="-1"></a>  U   <span class="ot">&lt;-</span> pars<span class="sc">$</span>U                            <span class="co"># upper limit of integration</span></span>
<span id="cb77-6"><a href="adwf.html#cb77-6" aria-hidden="true" tabindex="-1"></a>  h   <span class="ot">&lt;-</span> ( U <span class="sc">-</span> L ) <span class="sc">/</span> n                     <span class="co"># bin size</span></span>
<span id="cb77-7"><a href="adwf.html#cb77-7" aria-hidden="true" tabindex="-1"></a>  b   <span class="ot">&lt;-</span> L <span class="sc">+</span> <span class="fu">c</span>( <span class="dv">0</span><span class="sc">:</span>n ) <span class="sc">*</span> h                  <span class="co"># lower boundaries of bins </span></span>
<span id="cb77-8"><a href="adwf.html#cb77-8" aria-hidden="true" tabindex="-1"></a>  y   <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> ( b[<span class="dv">1</span><span class="sc">:</span>n] <span class="sc">+</span> b[<span class="dv">2</span><span class="sc">:</span>( n <span class="sc">+</span> <span class="dv">1</span> )] ) <span class="co"># midpoints of bins</span></span>
<span id="cb77-9"><a href="adwf.html#cb77-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-10"><a href="adwf.html#cb77-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fertility matrix</span></span>
<span id="cb77-11"><a href="adwf.html#cb77-11" aria-hidden="true" tabindex="-1"></a>  Fmat        <span class="ot">&lt;-</span> <span class="fu">matrix</span>( <span class="dv">0</span>, n, n )</span>
<span id="cb77-12"><a href="adwf.html#cb77-12" aria-hidden="true" tabindex="-1"></a>  Fmat[]      <span class="ot">&lt;-</span> <span class="fu">matrix</span>( <span class="fu">fy</span>( y, pars, h ), n, n )</span>
<span id="cb77-13"><a href="adwf.html#cb77-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-14"><a href="adwf.html#cb77-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Survival matrix</span></span>
<span id="cb77-15"><a href="adwf.html#cb77-15" aria-hidden="true" tabindex="-1"></a>  Smat   <span class="ot">&lt;-</span> <span class="fu">c</span>( )</span>
<span id="cb77-16"><a href="adwf.html#cb77-16" aria-hidden="true" tabindex="-1"></a>  Smat   <span class="ot">&lt;-</span> <span class="fu">sx</span>( y, pars )</span>
<span id="cb77-17"><a href="adwf.html#cb77-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-18"><a href="adwf.html#cb77-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Growth matrix</span></span>
<span id="cb77-19"><a href="adwf.html#cb77-19" aria-hidden="true" tabindex="-1"></a>  Gmat   <span class="ot">&lt;-</span> <span class="fu">matrix</span>( <span class="dv">0</span>, n, n )</span>
<span id="cb77-20"><a href="adwf.html#cb77-20" aria-hidden="true" tabindex="-1"></a>  Gmat[] <span class="ot">&lt;-</span> <span class="fu">t</span>( <span class="fu">outer</span>( y, y, gxy, pars ) ) <span class="sc">*</span> h</span>
<span id="cb77-21"><a href="adwf.html#cb77-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-22"><a href="adwf.html#cb77-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Growth/survival transition matrix</span></span>
<span id="cb77-23"><a href="adwf.html#cb77-23" aria-hidden="true" tabindex="-1"></a>  Tmat   <span class="ot">&lt;-</span> <span class="fu">matrix</span>( <span class="dv">0</span>, n, n )</span>
<span id="cb77-24"><a href="adwf.html#cb77-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-25"><a href="adwf.html#cb77-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Correct for eviction of offspring</span></span>
<span id="cb77-26"><a href="adwf.html#cb77-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>( n <span class="sc">/</span> <span class="dv">2</span> ) ) {</span>
<span id="cb77-27"><a href="adwf.html#cb77-27" aria-hidden="true" tabindex="-1"></a>    Gmat[<span class="dv">1</span>,i] <span class="ot">&lt;-</span> Gmat[<span class="dv">1</span>,i] <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>( Gmat[,i] )</span>
<span id="cb77-28"><a href="adwf.html#cb77-28" aria-hidden="true" tabindex="-1"></a>    Tmat[,i]  <span class="ot">&lt;-</span> Gmat[,i] <span class="sc">*</span> Smat[i]</span>
<span id="cb77-29"><a href="adwf.html#cb77-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-30"><a href="adwf.html#cb77-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-31"><a href="adwf.html#cb77-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Correct eviction of large adults</span></span>
<span id="cb77-32"><a href="adwf.html#cb77-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>( i <span class="cf">in</span> ( n <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span> )<span class="sc">:</span>n ) {</span>
<span id="cb77-33"><a href="adwf.html#cb77-33" aria-hidden="true" tabindex="-1"></a>    Gmat[n,i] <span class="ot">&lt;-</span> Gmat[n,i] <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>( Gmat[,i] )</span>
<span id="cb77-34"><a href="adwf.html#cb77-34" aria-hidden="true" tabindex="-1"></a>    Tmat[,i]  <span class="ot">&lt;-</span> Gmat[,i] <span class="sc">*</span> Smat[i]</span>
<span id="cb77-35"><a href="adwf.html#cb77-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-36"><a href="adwf.html#cb77-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-37"><a href="adwf.html#cb77-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Full Kernel is simply a summation of fertility and transition matrices</span></span>
<span id="cb77-38"><a href="adwf.html#cb77-38" aria-hidden="true" tabindex="-1"></a>  k_yx <span class="ot">&lt;-</span> Fmat <span class="sc">+</span> Tmat</span>
<span id="cb77-39"><a href="adwf.html#cb77-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-40"><a href="adwf.html#cb77-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="fu">list</span>( <span class="at">k_yx    =</span> k_yx,</span>
<span id="cb77-41"><a href="adwf.html#cb77-41" aria-hidden="true" tabindex="-1"></a>                <span class="at">Fmat    =</span> Fmat,</span>
<span id="cb77-42"><a href="adwf.html#cb77-42" aria-hidden="true" tabindex="-1"></a>                <span class="at">Tmat    =</span> Tmat,</span>
<span id="cb77-43"><a href="adwf.html#cb77-43" aria-hidden="true" tabindex="-1"></a>                <span class="at">Gmat    =</span> Gmat,</span>
<span id="cb77-44"><a href="adwf.html#cb77-44" aria-hidden="true" tabindex="-1"></a>                <span class="at">meshpts =</span> y ) )</span>
<span id="cb77-45"><a href="adwf.html#cb77-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-46"><a href="adwf.html#cb77-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And we can use this function to calculate the mean population growth rate, <span class="math inline">\(\lambda_{mean}\)</span>:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="adwf.html#cb78-1" aria-hidden="true" tabindex="-1"></a>lambda_ipm <span class="ot">&lt;-</span> <span class="cf">function</span>( i ) {</span>
<span id="cb78-2"><a href="adwf.html#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="fu">Re</span>( <span class="fu">eigen</span>( <span class="fu">kernel</span>( i )<span class="sc">$</span>k_yx )<span class="sc">$</span>value[<span class="dv">1</span>] ) )</span>
<span id="cb78-3"><a href="adwf.html#cb78-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb78-4"><a href="adwf.html#cb78-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-5"><a href="adwf.html#cb78-5" aria-hidden="true" tabindex="-1"></a>lam_mean <span class="ot">&lt;-</span> <span class="fu">lambda_ipm</span>( pars_mean )</span>
<span id="cb78-6"><a href="adwf.html#cb78-6" aria-hidden="true" tabindex="-1"></a>lam_mean</span></code></pre></div>
<pre><code>## [1] 1.092364</code></pre>
<p>Now, let’s check the observed population growth rate (changes in number of individuals) against the projected population growth rate. The population growth rate should be more precise than asymptotic lambda in checking our models. Asymptotic lambda is the population growth rate at the “stable stage distribution” - the stage distribution that the population reaches after a long period of time.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="adwf.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the cleaned data</span></span>
<span id="cb80-2"><a href="adwf.html#cb80-2" aria-hidden="true" tabindex="-1"></a>Bou_gra_clean <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://raw.githubusercontent.com/aspen1030/RUPDemo/main/Bou_gra_clean.csv&quot;</span>)</span>
<span id="cb80-3"><a href="adwf.html#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="adwf.html#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Population counts at time t0</span></span>
<span id="cb80-5"><a href="adwf.html#cb80-5" aria-hidden="true" tabindex="-1"></a>pop_counts_t0 <span class="ot">&lt;-</span> Bou_gra_clean <span class="sc">%&gt;%</span></span>
<span id="cb80-6"><a href="adwf.html#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( Year, Quad ) <span class="sc">%&gt;%</span></span>
<span id="cb80-7"><a href="adwf.html#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>( <span class="at">n_t0 =</span> <span class="fu">n</span>( ) ) <span class="sc">%&gt;%</span> </span>
<span id="cb80-8"><a href="adwf.html#cb80-8" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb80-9"><a href="adwf.html#cb80-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">Year =</span> Year <span class="sc">+</span> <span class="dv">1</span> )</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;Year&#39;. You can override using the `.groups` argument.</code></pre>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="adwf.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Population counts at time t1</span></span>
<span id="cb82-2"><a href="adwf.html#cb82-2" aria-hidden="true" tabindex="-1"></a>pop_counts_t1 <span class="ot">&lt;-</span> Bou_gra_clean <span class="sc">%&gt;%</span></span>
<span id="cb82-3"><a href="adwf.html#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>( Year, Quad ) <span class="sc">%&gt;%</span></span>
<span id="cb82-4"><a href="adwf.html#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>( <span class="at">n_t1 =</span> <span class="fu">n</span>( ) ) <span class="sc">%&gt;%</span> </span>
<span id="cb82-5"><a href="adwf.html#cb82-5" aria-hidden="true" tabindex="-1"></a>  ungroup </span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;Year&#39;. You can override using the `.groups` argument.</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="adwf.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate observed population growth rates, </span></span>
<span id="cb84-2"><a href="adwf.html#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   accounting for discontinued sampling!</span></span>
<span id="cb84-3"><a href="adwf.html#cb84-3" aria-hidden="true" tabindex="-1"></a>pop_counts <span class="ot">&lt;-</span> <span class="fu">left_join</span>( pop_counts_t0, </span>
<span id="cb84-4"><a href="adwf.html#cb84-4" aria-hidden="true" tabindex="-1"></a>                         pop_counts_t1 ) <span class="sc">%&gt;%</span> </span>
<span id="cb84-5"><a href="adwf.html#cb84-5" aria-hidden="true" tabindex="-1"></a>                <span class="co"># by dropping NAs, we remove gaps in sampling!</span></span>
<span id="cb84-6"><a href="adwf.html#cb84-6" aria-hidden="true" tabindex="-1"></a>                drop_na <span class="sc">%&gt;%</span> </span>
<span id="cb84-7"><a href="adwf.html#cb84-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>( Year ) <span class="sc">%&gt;%</span> </span>
<span id="cb84-8"><a href="adwf.html#cb84-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarise</span>( <span class="at">n_t0 =</span> <span class="fu">sum</span>( n_t0 ),</span>
<span id="cb84-9"><a href="adwf.html#cb84-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n_t1 =</span> <span class="fu">sum</span>( n_t1 ) ) <span class="sc">%&gt;%</span> </span>
<span id="cb84-10"><a href="adwf.html#cb84-10" aria-hidden="true" tabindex="-1"></a>                ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb84-11"><a href="adwf.html#cb84-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>( <span class="at">obs_pgr =</span> n_t1 <span class="sc">/</span> n_t0 )</span></code></pre></div>
<pre><code>## Joining with `by = join_by(Year, Quad)`</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="adwf.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Geometric mean of yearly population growth rates</span></span>
<span id="cb86-2"><a href="adwf.html#cb86-2" aria-hidden="true" tabindex="-1"></a>lam_mean_count <span class="ot">&lt;-</span> <span class="fu">exp</span>( <span class="fu">mean</span>( <span class="fu">log</span>( pop_counts<span class="sc">$</span>obs_pgr ), <span class="at">na.rm =</span> T ) )</span>
<span id="cb86-3"><a href="adwf.html#cb86-3" aria-hidden="true" tabindex="-1"></a>lam_mean_count</span></code></pre></div>
<pre><code>## [1] 1.164344</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="adwf.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall (aggregated) population growth rate</span></span>
<span id="cb88-2"><a href="adwf.html#cb88-2" aria-hidden="true" tabindex="-1"></a>lam_mean_overall <span class="ot">&lt;-</span> <span class="fu">sum</span>( pop_counts<span class="sc">$</span>n_t1 ) <span class="sc">/</span> <span class="fu">sum</span>( pop_counts<span class="sc">$</span>n_t0 )</span>
<span id="cb88-3"><a href="adwf.html#cb88-3" aria-hidden="true" tabindex="-1"></a>lam_mean_overall</span></code></pre></div>
<pre><code>## [1] 1.05844</code></pre>
<p>Once we are satisfied with our IPM, we can move on to constructing it with ipmr!</p>
</div>
<div id="ipmr4" class="section level3 hasAnchor" number="4.4.10">
<h3><span class="header-section-number">4.4.10</span> 10. Building the IPM with <code>ipmr</code><a href="adwf.html#ipmr4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now we can move on to constructing the IPM using the ipmr syntax on which the PADRINO database relies. I will write out each component of the ipmr <code>init_ipm( )</code> function independently, then run them together at the end.</p>
<p>First, we initialize the <code>init_ipm( )</code> function:</p>
<pre><code>library( ipmr )
proto_ipm_P &lt;- init_ipm( sim_gen   = &quot;simple&quot;,
                         di_dd     = &quot;di&quot;,
                         det_stoch = &quot;det&quot; ) %&gt;% </code></pre>
<p>The first part of the function asks us to define three characteristics of the proto-IPM:</p>
<ul>
<li>Simple, or general?: Simple IPMs have a single continuous state variable, while general IPMs have one or more continuous state variables and/or discrete stages. Since our model only has a single continuous state variable (size), our proto-IPM is “simple.”</li>
<li>Density independent, or density dependent?: Our model is density independent, “di”.</li>
<li>Deterministic, or stochastic?: Our model is deterministic, “det”.</li>
</ul>
<p>Next, we define the first kernel:</p>
<pre><code>define_kernel(
    
    name      = &quot;P&quot;,
    
    family    = &quot;CC&quot;,
    
    formula   = s * g,

    s         = plogis( surv_b0 + 
                          surv_b1 * size_1 ), 
    
    g         = dnorm( size_2, mu_g, grow_sig ),
    mu_g      = grow_b0 + grow_b1 * size_1,
    grow_sig  = sqrt( a * exp( b * size_1 ) ),
    
    data_list = pars_mean,
    states    = list( c( &#39;size&#39; ) ),
    
    evict_cor = TRUE,
    evict_fun = truncated_distributions( fun    = &#39;norm&#39;,
                                         target = &#39;g&#39; )
    
  ) %&gt;% </code></pre>
<p>Here, we must define six characteristics of the kernel:</p>
<ul>
<li>Name: Give the kernel a name (derived from “F” for reproduction or “P” for survival/growth transition, but you can use other letters as necessary for more complex models).<br />
</li>
<li>Family: What kind of transition does this kernel describe? The first letter denotes the type of state variable of the input to the kernel, and the second letter denotes the type of state variable of the output to the kernel. “C” indicates a continuous state variable, while “D” indicates a discrete state variable. For simple IPMs like ours, this will always be “CC”.<br />
</li>
<li>Formula: How do the vital rates generate the sub-kernel? For our P kernel, the sub-kernel is the product of the survival and growth vital rates.<br />
</li>
<li>Vital rate expressions: Now we must define all of the vital rates which we just wrote into the formula. Recall back to when we sketched out the IPM and wrote out the vital rate models in three different forms! In the case of our survival model, <code>s</code>, this is just the inverse of the link function of our survival GLM. In the case of our growth model, <code>g</code>, we must write three expressions. The first describes the Gaussian probability density distribution from which size at time t1 (which we denote as “size_2”) is drawn; the second defines <span class="math inline">\(\mu_{g}\)</span> based on size at time t0 (“size_1”) which will be input into the probability density distribution; and the third defines <span class="math inline">\(\sigma_{g}\)</span> based on size_1. Since the Gaussian distribution takes the identity link function, there is no need to define the inverse of the link function. The non-linear least squares estimate for <span class="math inline">\(\sigma_{g}\)</span> must be transformed as the square root.<br />
</li>
<li>Specify parameters: Here, we must tell ipmr where to find the values of the parameters we just defined and assign them to the data_list. In this case, it is our mean parameters dataframe. We need to also define the state variable(s), which in our case is just “size”.<br />
</li>
<li>Eviction correction: If the model corrects for eviction (which ours does), we need to define which functions should be corrected and the method used to correct for eviction. In our case, it is only the growth function that should be corrected following the normal distribution (for now), and the only method that is currently supported by ipmr is the <code>truncated_distributions( )</code> option.</li>
</ul>
<p>Next, we need to define the implementation of our proto-IPM:</p>
<pre><code>define_impl(
    
    make_impl_args_list(
      kernel_names = c( &quot;P&quot; ),
      int_rule     = rep( &quot;midpoint&quot;, 1 ),
      state_start  = rep( &quot;size&quot;, 1 ),
      state_end    = rep( &quot;size&quot;, 1 )
    )
    
  ) %&gt;% </code></pre>
<p>We use the helper function <code>make_impl_args_list( )</code> in ipmr to define four components for implementation of the proto-IPM:</p>
<ul>
<li>Kernel names: List the names of the kernels that we’ve defined as a vector.<br />
</li>
<li>Integration rule: Currently, the only option is the “midpoint” rule, which should be repeated for each kernel that we’ve defined.<br />
</li>
<li>State start: Which state variable starts as the input to each kernel? In simple IPMs, this will always be the continuous state variable.<br />
</li>
<li>State end: Which state variable ends as the output to each kernel? Again, this is the continuous state variable in simple IPMs like ours.</li>
</ul>
<p>Now we need to define the domains and the initial state of the population:</p>
<pre><code>define_domains(
    
    size = c( pars_mean$L,
              pars_mean$U,
              pars_mean$mat_siz
    )
    
  ) %&gt;%
  
define_pop_state(
    n_size     = rep( 1 / 200, 200 )
  )</code></pre>
<p>To define the domains, we need to give ipmr three parameters that describe the continuous state variable. The first value is the lower bound of the domain, i.e. the lower limit of integration. The second value is the upper bound of the domain, i.e. the upper limit of integration. The third value is the number of meshpoints for the domain, which is 200 in our case.</p>
<p>Then, because ipmr computes everything through simulation and this requires an input population state, we define the initial state of the population based on the number of meshpoints, i.e. assuming an equal number of individuals in each bin.</p>
<p>Now, we can put everything together and implement the proto-IPM!</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="adwf.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( ipmr )</span>
<span id="cb94-2"><a href="adwf.html#cb94-2" aria-hidden="true" tabindex="-1"></a>proto_ipm_p <span class="ot">&lt;-</span> <span class="fu">init_ipm</span>( <span class="at">sim_gen   =</span> <span class="st">&quot;simple&quot;</span>,</span>
<span id="cb94-3"><a href="adwf.html#cb94-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">di_dd     =</span> <span class="st">&quot;di&quot;</span>,</span>
<span id="cb94-4"><a href="adwf.html#cb94-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">det_stoch =</span> <span class="st">&quot;det&quot;</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb94-5"><a href="adwf.html#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb94-6"><a href="adwf.html#cb94-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-7"><a href="adwf.html#cb94-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">name      =</span> <span class="st">&quot;P&quot;</span>,</span>
<span id="cb94-8"><a href="adwf.html#cb94-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-9"><a href="adwf.html#cb94-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">family    =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb94-10"><a href="adwf.html#cb94-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-11"><a href="adwf.html#cb94-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula   =</span> s <span class="sc">*</span> g,</span>
<span id="cb94-12"><a href="adwf.html#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="adwf.html#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">s         =</span> <span class="fu">plogis</span>( surv_b0 <span class="sc">+</span> </span>
<span id="cb94-14"><a href="adwf.html#cb94-14" aria-hidden="true" tabindex="-1"></a>                          surv_b1 <span class="sc">*</span> size_1 ), </span>
<span id="cb94-15"><a href="adwf.html#cb94-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-16"><a href="adwf.html#cb94-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">g         =</span> <span class="fu">dnorm</span>( size_2, mu_g, grow_sig ),</span>
<span id="cb94-17"><a href="adwf.html#cb94-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_g      =</span> grow_b0 <span class="sc">+</span> grow_b1 <span class="sc">*</span> size_1,</span>
<span id="cb94-18"><a href="adwf.html#cb94-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">grow_sig  =</span> <span class="fu">sqrt</span>( a <span class="sc">*</span> <span class="fu">exp</span>( b <span class="sc">*</span> size_1 ) ),</span>
<span id="cb94-19"><a href="adwf.html#cb94-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-20"><a href="adwf.html#cb94-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list =</span> pars_mean,</span>
<span id="cb94-21"><a href="adwf.html#cb94-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">states    =</span> <span class="fu">list</span>( <span class="fu">c</span>( <span class="st">&#39;size&#39;</span> ) ),</span>
<span id="cb94-22"><a href="adwf.html#cb94-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-23"><a href="adwf.html#cb94-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor =</span> <span class="cn">TRUE</span>,</span>
<span id="cb94-24"><a href="adwf.html#cb94-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun =</span> <span class="fu">truncated_distributions</span>( <span class="at">fun    =</span> <span class="st">&#39;norm&#39;</span>,</span>
<span id="cb94-25"><a href="adwf.html#cb94-25" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">target =</span> <span class="st">&#39;g&#39;</span> )</span>
<span id="cb94-26"><a href="adwf.html#cb94-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-27"><a href="adwf.html#cb94-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb94-28"><a href="adwf.html#cb94-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_impl</span>(</span>
<span id="cb94-29"><a href="adwf.html#cb94-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-30"><a href="adwf.html#cb94-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_impl_args_list</span>(</span>
<span id="cb94-31"><a href="adwf.html#cb94-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">kernel_names =</span> <span class="fu">c</span>( <span class="st">&quot;P&quot;</span> ),</span>
<span id="cb94-32"><a href="adwf.html#cb94-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">int_rule     =</span> <span class="fu">rep</span>( <span class="st">&quot;midpoint&quot;</span>, <span class="dv">1</span> ),</span>
<span id="cb94-33"><a href="adwf.html#cb94-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_start  =</span> <span class="fu">rep</span>( <span class="st">&quot;size&quot;</span>, <span class="dv">1</span> ),</span>
<span id="cb94-34"><a href="adwf.html#cb94-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_end    =</span> <span class="fu">rep</span>( <span class="st">&quot;size&quot;</span>, <span class="dv">1</span> )</span>
<span id="cb94-35"><a href="adwf.html#cb94-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-36"><a href="adwf.html#cb94-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-37"><a href="adwf.html#cb94-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb94-38"><a href="adwf.html#cb94-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_domains</span>(</span>
<span id="cb94-39"><a href="adwf.html#cb94-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-40"><a href="adwf.html#cb94-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">c</span>( pars_mean<span class="sc">$</span>L,</span>
<span id="cb94-41"><a href="adwf.html#cb94-41" aria-hidden="true" tabindex="-1"></a>              pars_mean<span class="sc">$</span>U,</span>
<span id="cb94-42"><a href="adwf.html#cb94-42" aria-hidden="true" tabindex="-1"></a>              pars_mean<span class="sc">$</span>mat_siz</span>
<span id="cb94-43"><a href="adwf.html#cb94-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-44"><a href="adwf.html#cb94-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-45"><a href="adwf.html#cb94-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb94-46"><a href="adwf.html#cb94-46" aria-hidden="true" tabindex="-1"></a><span class="fu">define_pop_state</span>(</span>
<span id="cb94-47"><a href="adwf.html#cb94-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_size     =</span> <span class="fu">rep</span>( <span class="dv">1</span> <span class="sc">/</span> <span class="dv">200</span>, <span class="dv">200</span> )</span>
<span id="cb94-48"><a href="adwf.html#cb94-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-49"><a href="adwf.html#cb94-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-50"><a href="adwf.html#cb94-50" aria-hidden="true" tabindex="-1"></a>ipmr_p <span class="ot">&lt;-</span> <span class="fu">make_ipm</span>( <span class="at">proto_ipm  =</span> proto_ipm_p, </span>
<span id="cb94-51"><a href="adwf.html#cb94-51" aria-hidden="true" tabindex="-1"></a>                    <span class="at">iterations =</span> <span class="dv">200</span> )</span>
<span id="cb94-52"><a href="adwf.html#cb94-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-53"><a href="adwf.html#cb94-53" aria-hidden="true" tabindex="-1"></a><span class="fu">lambda</span>( ipmr_p )</span></code></pre></div>
<pre><code>##   lambda 
## 0.866924</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="adwf.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( ipmr_p )</span></code></pre></div>
<p><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-47-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>Without the recruitment kernel, the survival/growth transition kernel produces a lambda that is less than one. Let’s add the recruitment kernel and see how that lambda changes. I will not add commentary here, as everything new follows the same logic as in the first proto-IPM.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="adwf.html#cb97-1" aria-hidden="true" tabindex="-1"></a>proto_ipm_pf <span class="ot">&lt;-</span> <span class="fu">init_ipm</span>( <span class="at">sim_gen   =</span> <span class="st">&quot;simple&quot;</span>,</span>
<span id="cb97-2"><a href="adwf.html#cb97-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">di_dd     =</span> <span class="st">&quot;di&quot;</span>,</span>
<span id="cb97-3"><a href="adwf.html#cb97-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">det_stoch =</span> <span class="st">&quot;det&quot;</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb97-4"><a href="adwf.html#cb97-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-5"><a href="adwf.html#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb97-6"><a href="adwf.html#cb97-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name      =</span> <span class="st">&quot;P&quot;</span>,</span>
<span id="cb97-7"><a href="adwf.html#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">family    =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb97-8"><a href="adwf.html#cb97-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula   =</span> s <span class="sc">*</span> g,</span>
<span id="cb97-9"><a href="adwf.html#cb97-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">s         =</span> <span class="fu">plogis</span>( surv_b0 <span class="sc">+</span> </span>
<span id="cb97-10"><a href="adwf.html#cb97-10" aria-hidden="true" tabindex="-1"></a>                          surv_b1 <span class="sc">*</span> size_1), </span>
<span id="cb97-11"><a href="adwf.html#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">g         =</span> <span class="fu">dnorm</span>( size_2, mu_g, grow_sig ),</span>
<span id="cb97-12"><a href="adwf.html#cb97-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_g      =</span> grow_b0 <span class="sc">+</span> grow_b1 <span class="sc">*</span> size_1,</span>
<span id="cb97-13"><a href="adwf.html#cb97-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">grow_sig  =</span> <span class="fu">sqrt</span>( a <span class="sc">*</span> <span class="fu">exp</span>( b <span class="sc">*</span> size_1 ) ),</span>
<span id="cb97-14"><a href="adwf.html#cb97-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list =</span> pars_mean,</span>
<span id="cb97-15"><a href="adwf.html#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">states    =</span> <span class="fu">list</span>( <span class="fu">c</span>( <span class="st">&#39;size&#39;</span> ) ),</span>
<span id="cb97-16"><a href="adwf.html#cb97-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor =</span> <span class="cn">TRUE</span>,</span>
<span id="cb97-17"><a href="adwf.html#cb97-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun =</span> <span class="fu">truncated_distributions</span>( <span class="at">fun    =</span> <span class="st">&#39;norm&#39;</span>,</span>
<span id="cb97-18"><a href="adwf.html#cb97-18" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">target =</span> <span class="st">&#39;g&#39;</span> )</span>
<span id="cb97-19"><a href="adwf.html#cb97-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb97-20"><a href="adwf.html#cb97-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-21"><a href="adwf.html#cb97-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb97-22"><a href="adwf.html#cb97-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">name      =</span> <span class="st">&#39;F&#39;</span>,</span>
<span id="cb97-23"><a href="adwf.html#cb97-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">family    =</span> <span class="st">&#39;CC&#39;</span>,</span>
<span id="cb97-24"><a href="adwf.html#cb97-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula   =</span> fecu_b0 <span class="sc">*</span> r_d,</span>
<span id="cb97-25"><a href="adwf.html#cb97-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_d       =</span> <span class="fu">dnorm</span>( size_2, recr_sz, recr_sd ),</span>
<span id="cb97-26"><a href="adwf.html#cb97-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list =</span> pars_mean,</span>
<span id="cb97-27"><a href="adwf.html#cb97-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">states    =</span> <span class="fu">list</span>( <span class="fu">c</span>( <span class="st">&#39;size&#39;</span> ) ),</span>
<span id="cb97-28"><a href="adwf.html#cb97-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor =</span> <span class="cn">TRUE</span>,</span>
<span id="cb97-29"><a href="adwf.html#cb97-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun =</span> <span class="fu">truncated_distributions</span>( <span class="st">&quot;norm&quot;</span>, <span class="st">&quot;r_d&quot;</span> )</span>
<span id="cb97-30"><a href="adwf.html#cb97-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb97-31"><a href="adwf.html#cb97-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-32"><a href="adwf.html#cb97-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_impl</span>(</span>
<span id="cb97-33"><a href="adwf.html#cb97-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_impl_args_list</span>(</span>
<span id="cb97-34"><a href="adwf.html#cb97-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">kernel_names =</span> <span class="fu">c</span>( <span class="st">&quot;P&quot;</span>, <span class="st">&quot;F&quot;</span> ),</span>
<span id="cb97-35"><a href="adwf.html#cb97-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">int_rule     =</span> <span class="fu">rep</span>( <span class="st">&quot;midpoint&quot;</span>, <span class="dv">2</span> ),</span>
<span id="cb97-36"><a href="adwf.html#cb97-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_start  =</span> <span class="fu">rep</span>( <span class="st">&quot;size&quot;</span>, <span class="dv">2</span> ),</span>
<span id="cb97-37"><a href="adwf.html#cb97-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_end    =</span> <span class="fu">rep</span>( <span class="st">&quot;size&quot;</span>, <span class="dv">2</span> )</span>
<span id="cb97-38"><a href="adwf.html#cb97-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb97-39"><a href="adwf.html#cb97-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb97-40"><a href="adwf.html#cb97-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-41"><a href="adwf.html#cb97-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_domains</span>(</span>
<span id="cb97-42"><a href="adwf.html#cb97-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">c</span>(pars_mean<span class="sc">$</span>L,</span>
<span id="cb97-43"><a href="adwf.html#cb97-43" aria-hidden="true" tabindex="-1"></a>             pars_mean<span class="sc">$</span>U,</span>
<span id="cb97-44"><a href="adwf.html#cb97-44" aria-hidden="true" tabindex="-1"></a>             pars_mean<span class="sc">$</span>mat_siz</span>
<span id="cb97-45"><a href="adwf.html#cb97-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb97-46"><a href="adwf.html#cb97-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb97-47"><a href="adwf.html#cb97-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-48"><a href="adwf.html#cb97-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_pop_state</span>(</span>
<span id="cb97-49"><a href="adwf.html#cb97-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_size =</span> <span class="fu">rep</span>( <span class="dv">1</span> <span class="sc">/</span> <span class="dv">200</span>, <span class="dv">200</span> )</span>
<span id="cb97-50"><a href="adwf.html#cb97-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb97-51"><a href="adwf.html#cb97-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-52"><a href="adwf.html#cb97-52" aria-hidden="true" tabindex="-1"></a>ipmr_pf <span class="ot">&lt;-</span> <span class="fu">make_ipm</span>( <span class="at">proto_ipm =</span> proto_ipm_pf,</span>
<span id="cb97-53"><a href="adwf.html#cb97-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">iterations =</span> <span class="dv">200</span> )</span>
<span id="cb97-54"><a href="adwf.html#cb97-54" aria-hidden="true" tabindex="-1"></a>lam_mean_ipmr <span class="ot">&lt;-</span> <span class="fu">lambda</span>( ipmr_pf )</span>
<span id="cb97-55"><a href="adwf.html#cb97-55" aria-hidden="true" tabindex="-1"></a>lam_mean_ipmr</span></code></pre></div>
<pre><code>##   lambda 
## 1.099794</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="adwf.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( ipmr_pf )</span></code></pre></div>
<img src="rupdemo-webpage_files/figure-html/unnamed-chunk-48-1.png" width="576" style="display: block; margin: auto;" /><img src="rupdemo-webpage_files/figure-html/unnamed-chunk-48-2.png" width="576" style="display: block; margin: auto;" />
<center>
<table class="gmisc_table" style="border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;">
<thead>
<tr>
<th style="font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
Mean lambda
</th>
<th style="font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
Value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="padding-left: 1em; padding-right: 1em; text-align: left;">
From scratch
</td>
<td style="padding-left: 1em; padding-right: 1em; text-align: center;">
1.0924
</td>
</tr>
<tr>
<td style="padding-left: 1em; padding-right: 1em; border-bottom: 2px solid grey; text-align: left;">
From ipmr
</td>
<td style="padding-left: 1em; padding-right: 1em; border-bottom: 2px solid grey; text-align: center;">
1.0998
</td>
</tr>
</tbody>
</table>
</center>
<p>These lambda values are very close! We can go ahead and move onto the penultimate step.</p>
</div>
<div id="populating-the-padrino-database-template" class="section level3 hasAnchor" number="4.4.11">
<h3><span class="header-section-number">4.4.11</span> 11. Populating the PADRINO database template<a href="adwf.html#populating-the-padrino-database-template" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now that we have everything we need to construct our IPM using the ipmr syntax, we are ready to prep the IPM for inclusion in the PADRINO database. Be sure to have the <code>pars_mean</code> dataframe as well as the lambda value from the mean model loaded and ready to pull values from.</p>
<p>First, we need to load in the Excel file of the empty template. Download the template from <a href="https://github.com/aspen1030/RUPDemo/blob/4e814fc5feb0cb06634cec51a56756b9fdf20c62/pdb_template.xlsx">here</a> and store it locally. Paste in the path to this script:</p>
<pre><code>library( readxl )

YOUR_PATH &lt;- &quot;this is where you should paste the path to the folder where you&#39;ve stored your file&quot;
sheet_names &lt;- excel_sheets( paste( YOUR_PATH, &quot;/pdb_template.xlsx&quot;, sep = &quot;&quot; ) )
pdb &lt;- lapply( sheet_names, function( x ) {
  as.data.frame( read_excel( paste( YOUR_PATH, &quot;/pdb_template.xlsx&quot;, sep = &quot;&quot; ), sheet = x ) ) } )
names( pdb ) &lt;- sheet_names</code></pre>
<p>The <code>pdb</code> file contains 13 sheets, which are explained in better detail in the <a href="https://padrinodb.github.io/Padrino/digitization-guide.html#the-tables">PADRINO digitization guide</a>. We can get an overview of the different sheets with the <code>View( pdb )</code> function. Currently, each sheet should be a dataframe with 0 rows and 3 - 47 columns that are waiting to be filled.</p>
<p>I will use standard indexing to populate each of the relevant cells in the <code>pdb</code> file. It may not be the most efficient way to do this, but I find that it is easier to track down and correct mistakes.</p>
<p>First, we should populate the <code>Metadata</code> table. This table will contain information about the dataset which you will have already collected in steps 1 through 4. You may have to consult back with the data paper or other publications to fill in some of the missing info. Consult the PADRINO digitization guide to help you understand what information goes in each column (but note that the template has changed since this guide was written, so check the column names and other example pdb files for further clarification). For the sake of our example, the IPM ID of this dataset will be “bg0000”. I like to create one long vector for the <code>Metadata</code> table, instead of filling each cell individually, since the information will be contained on a single row.</p>
<pre><code>pdb$Metadata[1,] &lt;- c( &quot;bg0000&quot;, 
                       
                       # Taxonomic information
                       &quot;Bouteloua gracilis&quot;, &quot;Bouteloua gracilis&quot;, &quot;Bouteloua&quot;,
                       &quot;Poaceae&quot;, &quot;Poales&quot;, &quot;Liliopsida&quot;, &quot;Magnoliophyta&quot;,
                       &quot;Plantae&quot;, &quot;Herbaceous&quot;, &quot;Monocot&quot;, &quot;angio&quot;, 
                       
                       # Publication information
                       &quot;Chu; Norman; Flynn; Kaplan; Lauenroth; Adler&quot;,
                       &quot;Ecology&quot;, &quot;2013&quot;, &quot;10.1890/13-0121.1&quot;, &quot;Adler&quot;, 
                       &quot;peter.adler@usu.edu (2023)&quot;, NA, 
                       &quot;Chu, C., Norman, J., Flynn, R., Kaplan, N., Lauenroth,
                       W.K. and Adler, P.B. (2013), Cover, density, and
                       demographics of shortgrass steppe plants mapped 1997–2010
                       in permanent grazed and ungrazed quadrats. Ecology, 94:
                       1435-1435. https://doi.org/10.1890/13-0121.1&quot;,
                       &quot;https://doi.org/10.6084/m9.figshare.c.3305970.v1&quot;,
                       
                       # Data collection information
                       14, 1997, NA, 2010, NA, 1, &quot;Shortgrass Steppe LTER&quot;, &quot;6&quot;, 
                       &quot;40.84519843&quot;, &quot;-104.7107395&quot;, &quot;1652.2&quot;, &quot;USA&quot;,
                       &quot;n_america&quot;, &quot;TGS&quot;,
                       
                       # Model information
                       &quot;A&quot;, TRUE, &quot;truncated_distributions&quot;, &quot;P; F&quot;, NA, FALSE,
                       FALSE, FALSE, FALSE, &quot;&quot;, &quot;&quot;, &quot;&quot;
                        )
                        
pdb$Metadata$eviction_used &lt;- as.logical(pdb$Metadata$eviction_used)
pdb$Metadata$duration &lt;- as.numeric(pdb$Metadata$duration)
pdb$Metadata$periodicity &lt;- as.numeric(pdb$Metadata$periodicity)</code></pre>
<p>Some cells are case-sensitive, and some cells must be certain data types in order for ipmr to correctly parse the information. In general, copy what I or other digitizers have done. It also doesn’t hurt to run lines like the last line to make sure e.g. logical columns are stored as logical.</p>
<p>Next we will populate the <code>StateVariables</code> table. This table will also only contain one row, describing the single continuous state variable <code>size</code>. In general IPMs, this table may have multiple rows, one for each continuous or discrete state variable.</p>
<pre><code>pdb$StateVariables[1,] &lt;- c( &quot;bg0000&quot;, &quot;size&quot;, FALSE)
pdb$StateVariables$discrete &lt;- as.logical( pdb$StateVariables$discrete )</code></pre>
<p>As with the <code>StateVariables</code> table, the <code>ContinuousDomains</code> table also only contains a single row to describe our single state variable. This is the first table where we are using values from our <code>pars_mean</code> dataframe to define the limits of integration over our continuous domain. Notice that I am filling the cells that should be kept blank with “” instead of NA.</p>
<pre><code>pdb$ContinuousDomains[1,] &lt;- c( &quot;bg0000&quot;, 
                                &quot;size&quot;, 
                                &quot;&quot;, 
                                pars_mean$L, 
                                pars_mean$U, 
                                &quot;P; F&quot;, 
                                &quot;&quot; )
pdb$ContinuousDomains$lower &lt;- as.numeric( pdb$ContinuousDomains$lower )
pdb$ContinuousDomains$upper &lt;- as.numeric( pdb$ContinuousDomains$upper )</code></pre>
<p>Next is the <code>IntegrationRules</code> sheet. Again, this is a single row describing how we will integrate over our single continuous state variable.</p>
<pre><code>pdb$IntegrationRules[1,] &lt;- c( &quot;bg0000&quot;,
                               &quot;size&quot;,
                               &quot;&quot;,
                               pars_mean$mat_siz,
                               &quot;midpoint&quot;,
                               &quot;P; F&quot; )
pdb$IntegrationRules$n_meshpoints &lt;- as.numeric( pdb$IntegrationRules$n_meshpoints )</code></pre>
<p>Then the <code>StateVectors</code> sheet. This is where we tell ipmr how to initiate the population state for the simulation.</p>
<pre><code>pdb$StateVectors[1,] &lt;- c( &quot;bg0000&quot;,
                           &quot;n_size&quot;,
                           pars_mean$mat_siz,
                           &quot;&quot; )
pdb$StateVectors$n_bins &lt;- as.numeric( pdb$StateVectors$n_bins )</code></pre>
<p>Now we are getting to the more complicated tables. The <code>IpmKernels</code> sheet will have one row for each kernel we define, so two in the case of this IPM. Adding “<code>* d_size</code>” tells ipmr to integrate over the kernel with respect to <code>size</code>.</p>
<pre><code>pdb$IpmKernels[1,] &lt;- c( &quot;bg0000&quot;, 
                         &quot;P&quot;, 
                         &quot;P = s * g * d_size&quot;, 
                         &quot;CC&quot;, 
                         &quot;size&quot;, 
                         &quot;size&quot; )

pdb$IpmKernels[2,] &lt;- c( &quot;bg0000&quot;, 
                         &quot;F&quot;, 
                         &quot;F = fy * d_size&quot;, 
                         &quot;CC&quot;, 
                         &quot;size&quot;, 
                         &quot;size&quot; )</code></pre>
<p>Next, we need to define all of our vital rate expressions which compose our kernels, using the proper syntax. All probability density functions should have “Substituted” in the column <code>model_type</code> and all other expressions should be “Evaluated”. If necessary, long expressions can be split onto multiple rows, i.e. one row for the inverse logit link function for the survival vital rate and one row describing the inside of the expression. Note that you do not need to define the state variable in probability density functions.</p>
<pre><code>pdb$VitalRateExpr[1,] &lt;- c( &quot;bg0000&quot;,
                            &quot;Survival&quot;,
                            &quot;s = 1 / ( 1 + exp( -( surv_b0 + surv_b1 * size_1 ) ) )&quot;,
                            &quot;Evaluated&quot;,
                            &quot;P&quot; )

pdb$VitalRateExpr[2,] &lt;- c( &quot;bg0000&quot;,
                            &quot;Growth&quot;,
                            &quot;mu_g = grow_b0 + grow_b1 * size_1&quot;,
                            &quot;Evaluated&quot;,
                            &quot;P&quot; )

pdb$VitalRateExpr[3,] &lt;- c( &quot;bg0000&quot;,
                            &quot;Growth&quot;,
                            &quot;g = Norm( mu_g, sd_g )&quot;,
                            &quot;Substituted&quot;,
                            &quot;P&quot; )

pdb$VitalRateExpr[4,] &lt;- c( &quot;bg0000&quot;,
                            &quot;Growth&quot;,
                            &quot;sd_g = sqrt( a * exp( b * size_1 ) )&quot;,
                            &quot;Evaluated&quot;,
                            &quot;P&quot; )

pdb$VitalRateExpr[5,] &lt;- c( &quot;bg0000&quot;,
                            &quot;Fecundity&quot;,
                            &quot;fy = fecu_b0 * r_d&quot;,
                            &quot;Evaluated&quot;,
                            &quot;F&quot; )

pdb$VitalRateExpr[6,] &lt;- c( &quot;bg0000&quot;,
                            &quot;Fecundity&quot;,
                            &quot;r_d = Norm( recr_sz, recr_sd )&quot;,
                            &quot;Substituted&quot;,
                            &quot;F&quot; )</code></pre>
<p>Next, we need to define values for all of the parameters we just wrote in our vital rate expressions. These values go into the <code>ParameterValues</code> sheet.</p>
<pre><code>pdb$ParameterValues[1,] &lt;- c( &quot;bg0000&quot;,
                              &quot;Survival&quot;,
                              &quot;size&quot;,
                              &quot;surv_b0&quot;,
                              pars_mean$surv_b0 )
                              
pdb$ParameterValues[2,] &lt;- c( &quot;bg0000&quot;,
                              &quot;Survival&quot;,
                              &quot;size&quot;,
                              &quot;surv_b1&quot;,
                              pars_mean$surv_b1 )
                              
pdb$ParameterValues[3,] &lt;- c( &quot;bg0000&quot;,
                              &quot;Growth&quot;,
                              &quot;size&quot;,
                              &quot;grow_b0&quot;,
                              pars_mean$grow_b0 )
                              
pdb$ParameterValues[4,] &lt;- c( &quot;bg0000&quot;,
                              &quot;Growth&quot;,
                              &quot;size&quot;,
                              &quot;grow_b1&quot;,
                              pars_mean$grow_b1 )

pdb$ParameterValues[5,] &lt;- c( &quot;bg0000&quot;,
                              &quot;Growth&quot;,
                              &quot;size&quot;,
                              &quot;a&quot;,
                              pars_mean$a )
                              
pdb$ParameterValues[6,] &lt;- c( &quot;bg0000&quot;,
                              &quot;Growth&quot;,
                              &quot;size&quot;,
                              &quot;b&quot;,
                              pars_mean$b )

pdb$ParameterValues[7,] &lt;- c( &quot;bg0000&quot;,
                              &quot;Fecundity&quot;,
                              &quot;size&quot;,
                              &quot;fecu_b0&quot;,
                              pars_mean$fecu_b0 )

pdb$ParameterValues[8,] &lt;- c( &quot;bg0000&quot;,
                              &quot;Fecundity&quot;,
                              &quot;size&quot;,
                              &quot;recr_sz&quot;,
                              pars_mean$recr_sz )

pdb$ParameterValues[9,] &lt;- c( &quot;bg0000&quot;,
                              &quot;Fecundity&quot;,
                              &quot;size&quot;,
                              &quot;recr_sd&quot;,
                              pars_mean$recr_sd )
                              
pdb$ParameterValues$parameter_value &lt;- as.numeric( pdb$ParameterValues$parameter_value )</code></pre>
<p>For this IPM, we will skip the <code>EnvironmentalVariables</code>, <code>ParSetIndices</code>, and <code>UncertaintyTable</code> tables. The last table we will fill is the <code>TestTargets</code> table, with a single row.</p>
<pre><code>pdb$TestTargets[1,] &lt;- c( &quot;bg0000&quot;,
                          &quot;lambda&quot;,
                          lam_mean_ipmr,
                          3 )

pdb$TestTargets$target_value &lt;- as.numeric( pdb$TestTargets$target_value )
pdb$TestTargets$precision &lt;- as.numeric( pdb$TestTargets$precision )</code></pre>
<p>Once all of the necessary sheets have been filled, export the <code>pdb</code> file to Excel, storing it in the project home folder.</p>
<pre><code>library( writexl )
write_xlsx( pdb, &quot;Bou_gra_pdb.xlsx&quot; )</code></pre>
<p>Now, we must test the <code>pdb</code> file to make sure ipmr can recreate the model from the Excel tables.</p>
<pre><code>library( pdbDigitUtils )
pdb_test       &lt;- read_pdb( &quot;Bou_gra_pdb.xlsx&quot; )
pdb_test_proto &lt;- pdb_make_proto_ipm( pdb_test, det_stoch = &quot;det&quot; )
print( pdb_test_proto$bg0000 )
bg_ipm_pdb &lt;- make_ipm( pdb_test_proto$bg0000 )
bg_ipm_pdb
lambda( bg_ipm_pdb )
test_model( pdb_test, id = &quot;bg0000&quot; )</code></pre>
<p>This is where we may start to see error messages which are difficult to interpret. In order to get this model to pass the test, I had to troubleshoot multiple tables and add several lines of code to make sure all of the necessary columns were stored as numeric or as logical values. Hopefully, by using this script as an example, you will not need to spend much time troubleshooting!</p>
</div>
<div id="finishing-up-the-digitization-project" class="section level3 hasAnchor" number="4.4.12">
<h3><span class="header-section-number">4.4.12</span> 12. Finishing up the digitization project<a href="adwf.html#finishing-up-the-digitization-project" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We have already saved the completely populated PADRINO database Excel file in the project home folder, and the name we gave the file is sufficient to differentiate it from other IPMs we might create from the Adler Colorado dataset. To share this Excel file outside of the home folder, it might be best to name it “Chu_2013_Bou_gra.xlsx” but for now, the name it has is fine.</p>
<p>Next, we should finalize our notes file. This can be a .txt file or an .R script, if you’d like. The notes file for this project, named “Bou_gra_notes.txt”, should contain the following information:</p>
<blockquote>
<ul>
<li>Only a single, simple, deterministic, density-independent IPM was constructed from these data, representing the mean model. All data were aggregated by treatment and by year to fit the vital rate models.<br />
</li>
<li>In the year 2000, a number of quadrats were not sampled. These included unun_7, unun_5b, unun_24, unun_11, ungz_5a, ungz_24, gzun_5b, gzun_5a, gzun_24, gzgz_7, gzgz_5b, and gzgz_5a.<br />
</li>
<li>Three individuals were observed to have sizes smaller than the minimum size. The sizes of these individuals were changed to the minimum size when the observed size was less than the minimum. These individuals were quad gzgz_24 BOUGRA_2003_53 in 2003 (size t0), quad gzgz_24 BOUGRA_2002_1 in 2003 (size_t0 in 2003, size_t1 in 2002) and quad ungz_24 BOUGRA_2006_7 in 2006 (size t0 in 2006).</li>
<li>The recruitment rate was calculated as the mean per-capita rate of recruitment, based on the number of adults observed at time t0 and the number of recruits observed at time t1.</li>
</ul>
</blockquote>
Now, we need to write the wrapper file. First, we should take a look at how our files have been organized up to now. The project folder should look something like this:
<center>
<table class="gmisc_table" style="border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;">
<tbody>
<tr style="border-top: 2px solid grey;">
<td style="border-top: 2px solid grey; text-align: left;">
📁 Adler_Colorado
</td>
<td style="border-top: 2px solid grey; text-align: left;">
</td>
<td style="border-top: 2px solid grey; text-align: left;">
</td>
<td style="border-top: 2px solid grey; text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
<span style="color:dodgerblue;">🅁</span> Adler_Colorado.Rproj
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
📁 data
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
📁 Bou_gra
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> Bou_gra.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> survival_df.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> growth_df.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> recruitment_df.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> Bou_gra_clean.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> survival_df_mod.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> growth_df_mod.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> recruitment_df_mod.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> grow_pars.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> surv_pars.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> other_pars.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> pars_mean.csv
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
📁 R
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
📁 Bou_gra
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
<span style="color:dodgerblue;">Ⓡ</span> 01_DataFormatting.R
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:dodgerblue;">Ⓡ</span> 02_Plotting.R
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:dodgerblue;">Ⓡ</span> 03_VitalRates.R
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:dodgerblue;">Ⓡ</span> 04_IPMScratch.R
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:dodgerblue;">Ⓡ</span> 05_ipmr.R
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:dodgerblue;">Ⓡ</span> 06_PADRINO.R
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
📁 results
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
📁 Bou_gra
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
↳
</td>
<td style="text-align: left;">
🖻 histograms.png
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖻 histograms_log.png
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖻 survival_binned.png
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖻 growth.png
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖻 recruit.png
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖻 recruit_nomax.png
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖻 grow_pred.png
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖻 survival_pred.png
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖻 recruit_pred.png
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖺 Chu_2013_fulltext.pdf
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
<span style="color:forestgreen;">🅇</span> Bou_gra_pdb.xlsx
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
🖹 Bou_gra_notes.txt
</td>
<td style="text-align: left;">
</td>
<td style="text-align: left;">
</td>
</tr>
<tr>
<td style="border-bottom: 2px solid grey; text-align: left;">
</td>
<td style="border-bottom: 2px solid grey; text-align: left;">
<span style="color:dodgerblue;">Ⓡ</span> Bou_gra_wrapper.R
</td>
<td style="border-bottom: 2px solid grey; text-align: left;">
</td>
<td style="border-bottom: 2px solid grey; text-align: left;">
</td>
</tr>
</tbody>
</table>
</center>
<p>Based on this, our wrapper file should contain the following information:</p>
<pre><code># Chu et al. 2013: Bouteloua gracilis IPM for PADRINO
# Aspen Workman, summer 2024

# Setup
library( bblme ) # ver 1.0.25
library( ggplot2 ) # ver 3.4.4
library( htmlTable ) # ver 2.4.2
library( ipmr ) # ver 0.0.7
library( lme4 ) # ver 1.1-33
library( patchwork ) # ver 1.1.2
library( pdbDigitUtils ) # ver 0.0.0.90
library( readxl ) # ver 1.4.2
library( tidyverse ) # ver 2.0.0
library( writexl ) # ver 1.4.2

base_dir &lt;- dirname( rstudioapi::getActiveDocumentContext()$path )
R_dir &lt;- paste( base_dir, &quot;/R/Bou_gra/&quot;, sep = &quot;&quot; )

setwd( base_dir )


# Overview ---------------------------------------------------------------------

# This R project concerns the construction of IPMs based on chart quadrat data 
  # from Chu et al., 2013. This file focuses on the dataset of Bouteloua
  # gracilis, which was converted from chart quadrat data to demographic data by
  # A. Workman and A. Compagnoni using plantTracker. The dataset consists of 13
  # transitions from 24 plots in Colorado, USA. A single, simple, deterministic, 
  # density-independent IPM was constructed from these data, representing the
  # mean model. This IPM was formatted for inclusion in the PADRINO database.
  
# Citation of data source:
  # Chu, C., Norman, J., Flynn, R., Kaplan, N., Lauenroth, W.K. and Adler, P.B. 
  # (2013), Cover, density, and demographics of shortgrass steppe plants mapped 
  # 1997–2010 in permanent grazed and ungrazed quadrats. Ecology, 94: 1435-1435. 
  # https://doi.org/10.1890/13-0121.1
  

# Project organization ---------------------------------------------------------

# Contained within the R project are all of the files needed to construct and
  # test multiple IPMs. The files which refer to the mean model for Bouteloua
  # gracilis are indicated by the abbreviation &quot;Bou_gra.&quot; The home folder of the
  # project contains the finalized PADRINO database Excel file 
  # (&quot;Bou_gra_pdb.xlsx&quot;), a text file describing decisions that were made about
  # the data during the modeling process (&quot;Bou_gra_notes.txt&quot;) and this wrapper
  # file.
  
# Data are stored in the &#39;data/Bou_gra&#39; subfolder. The raw data, &quot;Bou_gra.csv&quot;, 
  # is the output from plantTracker filtered for only occurrences of Bouteloua
  # gracilis. The steps to generate the other data files in this subfolder are
  # contained within the R scripts.
  
# The R scripts are stored in the &#39;R/Bou_gra&#39; subfolder. The number prefix of
  # the file name indicates the order in which the scripts should be executed.
  
# Plots which were created throughout the course of this project are stored in 
  # the &#39;results/Bou_gra&#39; subfolder. Plots with the &quot;_pred&quot; suffix in the file 
  # name indicate visualizations of the vital rate models, while all other plots
  # are visualizations of the raw data.


# Workflow ---------------------------------------------------------------------

# Format the raw data
source( paste0( R_dir, &quot;01_DataFormatting.R&quot; ) )

# Plot the raw data and clean the raw data
source( paste0( R_dir, &quot;02_Plotting.R&quot; ) )

# Fit vital rate models
source( paste0( R_dir, &quot;03_VitalRates.R&quot; ) )

# Construct IPM from scratch
source( paste0( R_dir, &quot;04_IPMScratch.R&quot; ) )

# Construct IPM using ipmr syntax
source( paste0( R_dir, &quot;05_ipmr.R&quot; ) )

# Populate the PADRINO database template
source( paste0( R_dir, &quot;06_PADRINO.R&quot; ) )

</code></pre>
<p>Now that we’ve finished the wrapper file and all of the files are organized, we should make sure the entire project is uploaded or otherwise synced to whatever cloud service we’ve decided to use.</p>
<p>The last step is to update the “Digitized” column in the Incoming literature Google Sheet to “Y” and celebrate our success!</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="genwf.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="adex.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
